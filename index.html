<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GAMA Awards Frame Creator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        /* Define CSS Variables for easy theme management */
        :root {
            --primary-purple: #4500b2; /* Deep Purple */
            --primary-pink: #d83361; /* Dark Pink */
            --light-gray: #f9fafb;
            --medium-gray: #e5e7eb;
            --dark-text: #333;
            --light-text: #666;
            --white: #fff;
        }

        /* Base Body Styles */
        body {
            font-family: 'Prompt', sans-serif;
            min-height: 100vh;
            color: var(--dark-text);
            /* Background gradient from bottom-purple to top-pink */
            background: linear-gradient(to top, var(--primary-purple), var(--primary-pink));
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        /* Header Gradient Bar */
        .header-gradient {
            background: linear-gradient(to right, var(--primary-purple), var(--primary-pink));
            height: 8px;
            width: 100%;
        }

        /* Card Styling */
        .card {
            background-color: var(--white);
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            padding: 1.5rem; /* Default padding */
        }
        @media (min-width: 768px) { /* Adjust padding for larger screens */
            .card {
                padding: 2rem;
            }
        }

        /* Frame Option Styling */
        .frame-option {
            transition: all 0.3s ease;
            cursor: pointer;
            background-color: var(--white);
            border: 1px solid var(--medium-gray);
            border-radius: 0.5rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 0.5rem; /* Padding for individual frame options */
            width: 90px; /* Fixed width for consistent display */
            height: 90px; /* Fixed height for consistent display */
            flex-shrink: 0; /* Prevent shrinking in flex container */
            text-align: center;
        }

        .frame-option:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        .frame-option.selected {
            border: 3px solid var(--primary-purple);
            transform: translateY(-5px);
            box-shadow: 0 8px 12px -2px rgba(0, 0, 0, 0.15);
        }
        
        .frame-option img {
            width: 60px; /* Fixed size for frame preview images */
            height: 60px;
            object-fit: contain;
            margin: 0 auto; /* Center image */
        }
        .frame-option p {
            font-size: 0.8rem; /* Smaller text for frame names */
            font-weight: 500;
            margin-top: 0.25rem;
            color: var(--dark-text);
        }

        /* Image Container (Preview Area) */
        .image-container {
            position: relative;
            width: 100%;
            padding-top: 100%; /* 1:1 Aspect Ratio (height equals width) */
            overflow: hidden;
            margin: 0 auto;
            background-color: var(--light-gray);
            border: 2px dashed var(--primary-purple);
            border-radius: 8px;
            cursor: grab; /* Indicate draggable */
        }
        .image-container:active {
            cursor: grabbing;
        }

        /* User Image and Frame Image Layers */
        .image-container > img {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover; /* User image covers the container */
            transform-origin: center center; /* Ensures scaling/translation from center */
            will-change: transform; /* Performance hint for browser */
        }
        .user-image {
            z-index: 5; /* User image beneath the frame */
            /* Initial transform will be applied via JS */
        }
        .frame-image {
            pointer-events: none; /* Allows clicks to pass through to the user image below for dragging */
            z-index: 10; /* Frame always on top */
            object-fit: contain; /* Frame image contains within the area */
        }

        /* Slider Styling */
        .slider {
            -webkit-appearance: none;
            width: 100%;
            height: 8px;
            border-radius: 4px;
            background: var(--medium-gray);
            outline: none;
            transition: opacity .2s;
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--primary-purple);
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        .slider::-webkit-slider-thumb:hover {
            background-color: var(--primary-pink);
        }

        .slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--primary-purple);
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        .slider::-moz-range-thumb:hover {
            background-color: var(--primary-pink);
        }

        /* Button Styling */
        .btn {
            transition: all 0.3s ease;
        }
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* File Upload Hidden Input */
        .file-upload {
            position: relative;
            overflow: hidden;
            display: inline-block;
            width: 100%;
        }
        .file-upload input[type=file] {
            position: absolute;
            top: 0;
            right: 0;
            min-width: 100%;
            min-height: 100%;
            font-size: 100px;
            text-align: right;
            filter: alpha(opacity=0);
            opacity: 0;
            outline: none;
            cursor: pointer;
            display: block;
        }

        /* Loading Overlay */
        .loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            color: var(--white);
            font-size: 24px;
            flex-direction: row; /* Ensure spinner and text are in a row */
        }
        .spinner {
            border: 5px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 5px solid var(--white);
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Responsive Adjustments */
        @media (max-width: 768px) {
            .container {
                padding-left: 1rem;
                padding-right: 1rem;
            }
            .h-24 {
                height: 5rem; /* Smaller logo on mobile */
            }
            .text-3xl {
                font-size: 2rem;
            }
            .text-xl {
                font-size: 1.5rem;
            }
            .frame-option {
                width: 80px; /* Even smaller for mobile */
                height: 80px;
                padding: 0.4rem;
            }
            .frame-option img {
                width: 50px;
                height: 50px;
            }
            .frame-option p {
                font-size: 0.75rem;
            }
            .grid-cols-1 .lg\:col-span-2 {
                grid-column: span 1 / span 1;
            }
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center">
    <div class="header-gradient"></div>

    <div class="container mx-auto px-4 py-8 max-w-7xl w-full">
        <div class="flex justify-center mb-6">
            <img src="https://hugmediacreation.com/wp-content/uploads/2025/06/logo-gama-awards.png" alt="GAMA Awards Logo" class="h-24">
        </div>

        <h1 class="text-3xl md:text-4xl font-bold text-center text-gray-800 mb-4">GAMA Awards Frame Creator</h1>
        <p class="text-center text-gray-600 mb-8 max-w-2xl mx-auto">
            เปลี่ยนรูปโปรไฟล์ของคุณให้โดดเด่นด้วยกรอบรูปภาพพิเศษจาก GAMA Awards อัพโหลดรูปภาพของคุณ เลือกกรอบที่ชอบ และดาวน์โหลดเพื่อใช้เป็นรูปโปรไฟล์ใหม่ของคุณ
        </p>

        <div class="mb-8 max-w-xl mx-auto">
            <div class="card p-6">
                <label class="block text-lg font-medium mb-3 text-gray-700">อัพโหลดรูปโปรไฟล์ของคุณ:</label>
                <div class="file-upload">
                    <button id="uploadBtn" class="w-full bg-gradient-to-r from-purple-800 to-pink-600 hover:from-purple-700 hover:to-pink-500 text-white py-3 px-6 rounded-lg font-medium flex items-center justify-center btn">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 0 003 3h10a3 0 003-3v-1m-4-8l-4-4m0 0l-4 4m4-4v12" />
                        </svg>
                        เลือกรูปภาพจากเครื่อง
                    </button>
                    <input type="file" id="imageUpload" accept="image/*">
                </div>
                <p id="selectedFileName" class="mt-2 text-center text-sm text-gray-500"></p>
            </div>
        </div>

        <div class="mb-8">
            <h2 class="text-xl font-medium mb-4 text-center text-gray-700">เลือกกรอบรูปภาพ</h2>
            <div class="flex flex-wrap justify-center gap-3">
                <div class="frame-option rounded-lg" data-frame="MAA">
                    <img src="https://hugmediacreation.com/photo/MASTER%20MULTILINE%20Award.png" alt="MAA" class="mx-auto">
                    <p>MAA</p>
                </div>
                <div class="frame-option rounded-lg" data-frame="MFA">
                    <img src="https://hugmediacreation.com/photo/MASTER%20FIRM%20Award.png" alt="MFA" class="mx-auto">
                    <p>MFA</p>
                </div>
                <div class="frame-option rounded-lg" data-frame="MMA">
                    <img src="https://hugmediacreation.com/photo/MASTER%20AGENCY%20Award.png" alt="MMA" class="mx-auto">
                    <p>MMA</p>
                </div>
                <div class="frame-option rounded-lg" data-frame="IMA">
                    <img src="https://hugmediacreation.com/photo/International%20Management%20Award.png" alt="IMA" class="mx-auto">
                    <p>IMA</p>
                </div>
                <div class="frame-option rounded-lg" data-frame="FLA">
                    <img src="https://hugmediacreation.com/photo/Frontline%20Leader%20Awards.png" alt="FLA" class="mx-auto">
                    <p>FLA</p>
                </div>
                <div class="frame-option rounded-lg" data-frame="ERA">
                    <img src="https://hugmediacreation.com/photo/Excellence%20Recruitment%20Award.png" alt="ERA" class="mx-auto">
                    <p>ERA</p>
                </div>
                <div class="frame-option rounded-lg" data-frame="COE">
                    <img src="https://hugmediacreation.com/photo/Circle%20of%20Excellence%20Award.png" alt="COE" class="mx-auto">
                    <p>COE</p>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
            <div class="lg:col-span-2">
                <div class="card p-4">
                    <div id="preview" class="image-container flex items-center justify-center">
                        <div id="placeholderText" class="text-center p-4 absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mx-auto mb-2 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 0 00-2 2v12a2 2 0 002 2z" />
                            </svg>
                            <p class="text-gray-500">โปรดอัพโหลดรูปภาพและเลือกกรอบ</p>
                        </div>
                        <img id="userImage" class="user-image hidden" src="" alt="User uploaded image">
                        <img id="frameImage" class="frame-image hidden" src="" alt="Selected frame">
                    </div>
                </div>
            </div>

            <div class="card p-6">
                <h3 class="text-lg font-medium mb-4 text-gray-700">ปรับแต่งรูปภาพ</h3>

                <div class="mb-4">
                    <label for="scaleSlider" class="block text-sm font-medium mb-1 text-gray-600">ขนาด:</label>
                    <input type="range" id="scaleSlider" class="slider w-full" min="50" max="300" value="100">
                    <div class="flex justify-between text-xs text-gray-500">
                        <span>เล็ก</span>
                        <span>ใหญ่</span>
                    </div>
                </div>

                <div class="mb-4">
                    <label for="xPosSlider" class="block text-sm font-medium mb-1 text-gray-600">ตำแหน่งแนวนอน:</label>
                    <input type="range" id="xPosSlider" class="slider w-full" min="-100" max="100" value="0">
                    <div class="flex justify-between text-xs text-gray-500">
                        <span>ซ้าย</span>
                        <span>ขวา</span>
                    </div>
                </div>

                <div class="mb-6">
                    <label for="yPosSlider" class="block text-sm font-medium mb-1 text-gray-600">ตำแหน่งแนวตั้ง:</label>
                    <input type="range" id="yPosSlider" class="slider w-full" min="-100" max="100" value="0">
                    <div class="flex justify-between text-xs text-gray-500">
                        <span>บน</span>
                        <span>ล่าง</span>
                    </div>
                </div>

                <button id="downloadBtn" class="w-full bg-gradient-to-r from-purple-800 to-pink-600 hover:from-purple-700 hover:to-pink-500 text-white py-3 px-6 rounded-lg font-medium flex items-center justify-center btn disabled:opacity-50 disabled:cursor-not-allowed mb-3" disabled>
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 0 003 3h10a3 0 003-3v-1m-4-8l-4-4m0 0l-4 4m4-4v12" />
                    </svg>
                    ดาวน์โหลดรูปโปรไฟล์
                </button>

                <p class="mt-4 text-sm text-gray-500 text-center">ดาวน์โหลดและใช้เป็นรูปโปรไฟล์ของคุณบนโซเชียลมีเดีย</p>
            </div>
        </div>

        <div class="text-center text-sm text-gray-500 mt-8 mb-4">
            © GAMA Awards 2025 - ระบบใส่กรอบรูปภาพ
        </div>
    </div>

    <div id="loadingOverlay" class="loading hidden">
        <div class="spinner"></div>
        <span>กำลังประมวลผล...</span>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // --- DOM Elements ---
            const imageUpload = document.getElementById('imageUpload');
            const uploadBtn = document.getElementById('uploadBtn');
            const selectedFileName = document.getElementById('selectedFileName');
            const frameOptions = document.querySelectorAll('.frame-option');
            const userImagePreview = document.getElementById('userImage');
            const frameImagePreview = document.getElementById('frameImage');
            const placeholderText = document.getElementById('placeholderText');
            const scaleSlider = document.getElementById('scaleSlider');
            const xPosSlider = document.getElementById('xPosSlider');
            const yPosSlider = document.getElementById('yPosSlider');
            const downloadBtn = document.getElementById('downloadBtn');
            const loadingOverlay = document.getElementById('loadingOverlay');
            const previewContainer = document.getElementById('preview'); // The image-container div for preview

            // --- Frame URLs Mapping ---
            // These URLs point to your frame images hosted on hugmediacreation.com
            const frameUrls = {
                'MAA': 'https://hugmediacreation.com/photo/MASTER%20MULTILINE%20Award.png',
                'MFA': 'https://hugmediacreation.com/photo/MASTER%20FIRM%20Award.png',
                'MMA': 'https://hugmediacreation.com/photo/MASTER%20AGENCY%20Award.png',
                'IMA': 'https://hugmediacreation.com/photo/International%20Management%20Award.png',
                'FLA': 'https://hugmediacreation.com/photo/Frontline%20Leader%20Awards.png',
                'ERA': 'https://hugmediacreation.com/photo/Excellence%20Recruitment%20Award.png',
                'COE': 'https://hugmediacreation.com/photo/Circle%20of%20Excellence%20Award.png'
            };

            // --- State Variables ---
            let selectedFrame = null;
            let userImageLoaded = false;
            let frameImageLoaded = false;
            let isDragging = false;
            let startPointerX, startPointerY; // Initial pointer position during drag
            let initialTranslateX, initialTranslateY; // Initial image translation (from sliders)
            let currentScale = 1;

            // --- Helper Functions ---

            // Checks if both user image and frame are loaded to enable download button
            function checkDownloadAvailability() {
                downloadBtn.disabled = !(userImageLoaded && selectedFrame && frameImageLoaded);
            }

            // Applies transform styles to the user image in the preview
            function updateImagePosition() {
                if (!userImageLoaded) return;

                // Get values directly from sliders (they represent percentages)
                const scale = parseFloat(scaleSlider.value) / 100;
                const xPos = parseFloat(xPosSlider.value);
                const yPos = parseFloat(yPosSlider.value);

                // Update current state
                currentScale = scale;
                initialTranslateX = xPos;
                initialTranslateY = yPos;

                // Apply transform using percentage translation for responsiveness
                userImagePreview.style.transform = `translate(${initialTranslateX}%, ${initialTranslateY}%) scale(${currentScale})`;
            }

            // --- Event Listeners ---

            // Simulate click on hidden file input when upload button is clicked
            uploadBtn.addEventListener('click', function() {
                imageUpload.click();
            });

            // Handle user image file upload
            imageUpload.addEventListener('change', function() {
                if (this.files && this.files[0]) {
                    const file = this.files[0];
                    selectedFileName.textContent = file.name;

                    const reader = new FileReader();
                    reader.onload = function(e) {
                        userImagePreview.onload = function() {
                            placeholderText.classList.add('hidden');
                            userImagePreview.classList.remove('hidden');
                            userImageLoaded = true;
                            // Reset sliders and transform when a new image is loaded
                            scaleSlider.value = 100;
                            xPosSlider.value = 0;
                            yPosSlider.value = 0;
                            updateImagePosition(); // Apply default positions
                            checkDownloadAvailability();
                        };
                        userImagePreview.onerror = function() {
                            alert('เกิดข้อผิดพลาดในการโหลดรูปภาพของคุณ กรุณาลองใหม่');
                            userImageLoaded = false;
                            checkDownloadAvailability();
                        };
                        userImagePreview.src = e.target.result;
                    };
                    reader.readAsDataURL(file);
                } else {
                    // No file selected
                    selectedFileName.textContent = '';
                    userImagePreview.classList.add('hidden');
                    placeholderText.classList.remove('hidden');
                    userImageLoaded = false;
                    checkDownloadAvailability();
                }
            });

            // Handle frame selection
            frameOptions.forEach(option => {
                option.addEventListener('click', function() {
                    const frameId = this.dataset.frame; // Get frame ID from data-frame attribute

                    // Remove 'selected' class from all other options
                    frameOptions.forEach(opt => opt.classList.remove('selected'));
                    // Add 'selected' class to the clicked option
                    this.classList.add('selected');

                    selectedFrame = frameId; // Store selected frame ID

                    // Load frame image for the main preview area
                    frameImagePreview.onload = function() {
                        frameImagePreview.classList.remove('hidden');
                        frameImageLoaded = true;
                        checkDownloadAvailability();
                    };
                    frameImagePreview.onerror = function() {
                        console.error('Failed to load frame image:', frameUrls[frameId]);
                        alert('เกิดข้อผิดพลาดในการโหลดกรอบรูป กรุณาตรวจสอบลิงก์รูปภาพกรอบอีกครั้ง หรือรูปภาพอาจถูกลบไปแล้ว');
                        frameImageLoaded = false;
                        checkDownloadAvailability();
                    };
                    frameImagePreview.src = frameUrls[frameId]; // Set the source of the frame image
                });
            });

            // Event listeners for sliders to update image position
            scaleSlider.addEventListener('input', updateImagePosition);
            xPosSlider.addEventListener('input', updateImagePosition);
            yPosSlider.addEventListener('input', updateImagePosition);

            // --- Dragging Functionality for User Image ---
            // Mouse events
            previewContainer.addEventListener('mousedown', (e) => {
                if (userImageLoaded && selectedFrame) {
                    isDragging = true;
                    e.preventDefault(); // Prevent default browser drag behavior
                    startPointerX = e.clientX;
                    startPointerY = e.clientY;
                    // Store current slider values as initial for relative drag calculation
                    initialTranslateX = parseFloat(xPosSlider.value);
                    initialTranslateY = parseFloat(yPosSlider.value);
                    previewContainer.style.cursor = 'grabbing'; // Change cursor to indicate dragging
                }
            });

            previewContainer.addEventListener('mousemove', (e) => {
                if (!isDragging || !userImageLoaded) return;
                
                const deltaX = e.clientX - startPointerX;
                const deltaY = e.clientY - startPointerY;

                // Calculate new percentage based on drag distance relative to container size
                // Factor of 200 (100 / 0.5) because slider range is -100 to 100, which covers 200% movement
                // If container is 300px wide, 100% translate is 300px. Slider 100 means move 300px.
                // 100% of container width in CSS `translate` equals `100` on slider.
                // So, 1 unit on slider corresponds to 1% of container width.
                // To move 1% of container width, we need to drag `containerWidth / 100` pixels.
                // So, deltaX pixels corresponds to `deltaX / (containerWidth / 100)` percentage.
                const newXPos = initialTranslateX + (deltaX / previewContainer.offsetWidth) * 100;
                const newYPos = initialTranslateY + (deltaY / previewContainer.offsetHeight) * 100;

                // Limit movement to slider's min/max range
                xPosSlider.value = Math.max(-100, Math.min(100, newXPos));
                yPosSlider.value = Math.max(-100, Math.min(100, newYPos));
                updateImagePosition(); // Apply new position
            });

            previewContainer.addEventListener('mouseup', () => {
                isDragging = false;
                previewContainer.style.cursor = 'grab'; // Reset cursor
            });

            previewContainer.addEventListener('mouseleave', () => {
                isDragging = false;
                previewContainer.style.cursor = 'grab'; // Reset cursor if mouse leaves while dragging
            });
            
            // Touch events for mobile dragging
            previewContainer.addEventListener('touchstart', (e) => {
                if (userImageLoaded && selectedFrame && e.touches.length === 1) {
                    isDragging = true;
                    e.preventDefault(); // Prevent scrolling on touch devices
                    const touch = e.touches[0];
                    startPointerX = touch.clientX;
                    startPointerY = touch.clientY;
                    initialTranslateX = parseFloat(xPosSlider.value);
                    initialTranslateY = parseFloat(yPosSlider.value);
                    previewContainer.style.cursor = 'grabbing';
                }
            }, { passive: false }); // Use passive: false to allow preventDefault

            previewContainer.addEventListener('touchmove', (e) => {
                if (!isDragging || !userImageLoaded || e.touches.length !== 1) return;
                
                const touch = e.touches[0];
                const deltaX = touch.clientX - startPointerX;
                const deltaY = touch.clientY - startPointerY;

                const newXPos = initialTranslateX + (deltaX / previewContainer.offsetWidth) * 100;
                const newYPos = initialTranslateY + (deltaY / previewContainer.offsetHeight) * 100;

                xPosSlider.value = Math.max(-100, Math.min(100, newXPos));
                yPosSlider.value = Math.max(-100, Math.min(100, newYPos));
                updateImagePosition();
            }, { passive: false });

            previewContainer.addEventListener('touchend', () => {
                isDragging = false;
                previewContainer.style.cursor = 'grab';
            });

            // --- Download Functionality ---
            downloadBtn.addEventListener('click', function() {
                if (!userImageLoaded || !selectedFrame || !frameImageLoaded) {
                    alert('โปรดอัปโหลดรูปภาพและเลือกกรอบก่อนดาวน์โหลด');
                    return;
                }

                loadingOverlay.classList.remove('hidden'); // Show loading overlay

                // Create a temporary div to render the full-resolution image
                const tempRenderDiv = document.createElement('div');
                tempRenderDiv.style.width = '1920px'; // Desired output resolution (e.g., for square profile pic)
                tempRenderDiv.style.height = '1920px';
                tempRenderDiv.style.position = 'absolute';
                tempRenderDiv.style.left = '-9999px'; // Hide it off-screen
                tempRenderDiv.style.top = '-9999px';
                tempRenderDiv.style.overflow = 'hidden';
                tempRenderDiv.style.backgroundColor = 'transparent'; // Ensure transparent background if needed
                tempRenderDiv.style.display = 'flex'; // Use flex to layer images
                tempRenderDiv.style.alignItems = 'center';
                tempRenderDiv.style.justifyContent = 'center';
                document.body.appendChild(tempRenderDiv);

                // Create new image elements for the high-res render
                const hiResUserImage = new Image();
                const hiResFrameImage = new Image();

                hiResUserImage.src = userImagePreview.src; // Use the same source as preview
                hiResFrameImage.src = frameImagePreview.src; // Use the same source as preview

                // Apply current transformations to the high-res user image
                // The values from sliders (initialTranslateX, initialTranslateY, currentScale) are already correct
                // for direct application, as they are percentage-based or absolute scale.
                hiResUserImage.style.transform = `translate(${initialTranslateX}%, ${initialTranslateY}%) scale(${currentScale})`;
                hiResUserImage.style.transformOrigin = 'center center';
                hiResUserImage.style.objectFit = 'cover';
                hiResUserImage.style.width = '100%';
                hiResUserImage.style.height = '100%';
                hiResUserImage.style.position = 'absolute';
                hiResUserImage.style.display = 'block';

                hiResFrameImage.style.width = '100%';
                hiResFrameImage.style.height = '100%';
                hiResFrameImage.style.position = 'absolute';
                hiResFrameImage.style.zIndex = '10'; // Ensure frame is on top
                hiResFrameImage.style.display = 'block';

                tempRenderDiv.appendChild(hiResUserImage);
                tempRenderDiv.appendChild(hiResFrameImage);

                // Wait for both high-resolution images to load in the temporary div
                Promise.all([
                    new Promise(resolve => {
                        if (hiResUserImage.complete) {
                            resolve();
                        } else {
                            hiResUserImage.onload = resolve;
                            hiResUserImage.onerror = () => {
                                console.error('High-res user image failed to load.');
                                resolve(); // Allow continuation even if one image fails to load
                            };
                        }
                    }),
                    new Promise(resolve => {
                        if (hiResFrameImage.complete) {
                            resolve();
                        } else {
                            hiResFrameImage.onload = resolve;
                            hiResFrameImage.onerror = () => {
                                console.error('High-res frame image failed to load. Check CORS or URL.');
                                resolve();
                            };
                        }
                    })
                ]).then(() => {
                    // All images loaded, now capture the div
                    html2canvas(tempRenderDiv, {
                        width: 1920,
                        height: 1920,
                        scale: 1, // Render at 1:1 pixel ratio for the 1920x1920 div
                        backgroundColor: null, // Keeps background transparent if it's not explicitly set
                        useCORS: true, // Crucial for external images to be rendered
                        allowTaint: false, // Prevents issues with tainted canvas
                        logging: true, // Enable logging for debugging
                        imageTimeout: 15000 // Timeout for image loading
                    }).then(canvas => {
                        // Remove the temporary div after capture
                        document.body.removeChild(tempRenderDiv);

                        try {
                            // Create a download link and trigger click
                            const link = document.createElement('a');
                            link.download = `profile-${selectedFrame}-gama-awards.png`;
                            link.href = canvas.toDataURL('image/png'); // Get image data as PNG
                            link.click();
                        } catch (e) {
                            console.error('Error creating data URL or download link:', e);
                            alert('ไม่สามารถดาวน์โหลดรูปภาพได้ (อาจเกิดจากปัญหาภายในหรือรูปภาพต้นฉบับเสียหาย หรือปัญหา CORS)');
                        }
                        loadingOverlay.classList.add('hidden'); // Hide loading overlay
                    }).catch(err => {
                        console.error('Error generating image with html2canvas:', err);
                        alert('เกิดข้อผิดพลาดในการสร้างรูปภาพ กรุณาลองใหม่อีกครั้ง');
                        document.body.removeChild(tempRenderDiv);
                        loadingOverlay.classList.add('hidden');
                    });
                }).catch(err => {
                    console.error('Error waiting for high-res images to load before html2canvas:', err);
                    alert('เกิดข้อผิดพลาดในการเตรียมรูปภาพเพื่อดาวน์โหลด กรุณาลองใหม่อีกครั้ง');
                    document.body.removeChild(tempRenderDiv);
                    loadingOverlay.classList.add('hidden');
                });
            });

            // --- Initial Setup ---
            updateImagePosition(); // Set initial position based on slider defaults
            checkDownloadAvailability(); // Check initial state for download button
        });
    </script>
</body>
</html>
