<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GAMA Awards Frame Creator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        /* Define CSS Variables for easy theme management */
        :root {
            --primary-purple: #4500b2; /* Deep Purple */
            --primary-pink: #d83361; /* Dark Pink */
            --light-gray: #f9fafb;
            --medium-gray: #e5e7eb;
            --dark-text: #333;
            --light-text: #666;
            --white: #fff;
        }

        /* Base Body Styles */
        body {
            font-family: 'Prompt', sans-serif;
            min-height: 100vh;
            color: var(--dark-text);
            /* Background gradient from bottom-purple to top-pink */
            background: linear-gradient(to top, var(--primary-purple), var(--primary-pink));
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        /* Header Gradient Bar */
        .header-gradient {
            background: linear-gradient(to right, var(--primary-purple), var(--primary-pink));
            height: 8px;
            width: 100%;
        }

        /* Card Styling */
        .card {
            background-color: var(--white);
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            padding: 1.5rem; /* Default padding */
        }
        @media (min-width: 768px) { /* Adjust padding for larger screens */
            .card {
                padding: 2rem;
            }
        }

        /* Frame Option Styling */
        .frame-option {
            transition: all 0.3s ease;
            cursor: pointer;
            background-color: var(--white);
            border: 1px solid var(--medium-gray);
            border-radius: 0.5rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 0.5rem; /* Padding for individual frame options */
            width: 90px; /* Fixed width for consistent display */
            height: 90px; /* Fixed height for consistent display */
            flex-shrink: 0; /* Prevent shrinking in flex container */
            text-align: center;
        }

        .frame-option:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        .frame-option.selected {
            border: 3px solid var(--primary-purple);
            transform: translateY(-5px);
            box-shadow: 0 8px 12px -2px rgba(0, 0, 0, 0.15);
        }
        
        .frame-option img {
            width: 60px; /* Fixed size for frame preview images */
            height: 60px;
            object-fit: contain;
            margin: 0 auto; /* Center image */
        }
        .frame-option p {
            font-size: 0.8rem; /* Smaller text for frame names */
            font-weight: 500;
            margin-top: 0.25rem;
            color: var(--dark-text);
        }

        /* Image Container (Preview Area) */
        .image-container {
            position: relative;
            width: 100%;
            padding-top: 100%; /* 1:1 Aspect Ratio (height equals width) */
            overflow: hidden;
            margin: 0 auto;
            background-color: var(--light-gray);
            border: 2px dashed var(--primary-purple);
            border-radius: 8px;
        }

        /* User Image and Frame Image Layers */
        .image-container > img {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover; /* User image covers the container while maintaining aspect ratio */
            transform-origin: center center; /* Ensures scaling/translation from center */
            will-change: transform; /* Performance hint for browser */
        }
        .user-image {
            z-index: 5; /* User image beneath the frame */
            /* Initial transform will be applied via JS */
        }
        .frame-image {
            pointer-events: none; /* Allows clicks to pass through to the user image below for dragging */
            z-index: 10; /* Frame always on top */
            object-fit: contain; /* Frame image contains within the area, maintaining aspect ratio */
        }

        /* Slider Styling */
        .slider {
            -webkit-appearance: none;
            width: 100%;
            height: 8px;
            border-radius: 4px;
            background: var(--medium-gray);
            outline: none;
            transition: opacity .2s;
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--primary-purple);
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        .slider::-webkit-slider-thumb:hover {
            background-color: var(--primary-pink);
        }

        .slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--primary-purple);
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        .slider::-moz-range-thumb:hover {
            background-color: var(--primary-pink);
        }

        /* Button Styling */
        .btn {
            transition: all 0.3s ease;
        }
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* File Upload Hidden Input */
        .file-upload {
            position: relative;
            overflow: hidden;
            display: inline-block;
            width: 100%;
        }
        .file-upload input[type=file] {
            position: absolute;
            top: 0;
            right: 0;
            min-width: 100%;
            min-height: 100%;
            font-size: 100px;
            text-align: right;
            filter: alpha(opacity=0);
            opacity: 0;
            outline: none;
            cursor: pointer;
            display: block;
        }

        /* Loading Overlay */
        .loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            color: var(--white);
            font-size: 24px;
            flex-direction: row; /* Ensure spinner and text are in a row */
        }
        .spinner {
            border: 5px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 5px solid var(--white);
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Responsive Adjustments */
        @media (max-width: 768px) {
            .container {
                padding-left: 1rem;
                padding-right: 1rem;
            }
            .h-24 {
                height: 5rem; /* Smaller logo on mobile */
            }
            .text-3xl {
                font-size: 2rem;
            }
            .text-xl {
                font-size: 1.5rem;
            }
            .frame-option {
                width: 80px; /* Even smaller for mobile */
                height: 80px;
                padding: 0.4rem;
            }
            .frame-option img {
                width: 50px;
                height: 50px;
            }
            .frame-option p {
                font-size: 0.75rem;
            }
            .grid-cols-1 .lg\:col-span-2 {
                grid-column: span 1 / span 1;
            }
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center">
    <div class="header-gradient"></div>

    <div class="container mx-auto px-4 py-8 max-w-7xl w-full">
        <div class="flex justify-center mb-6">
            <img src="https://hugmediacreation.com/wp-content/uploads/2025/06/logo-gama-awards.png" alt="GAMA Awards Logo" class="h-24">
        </div>

        <h1 class="text-3xl md:text-4xl font-bold text-center text-white mb-4">GAMA Awards Frame Creator</h1>
        <p class="text-center text-white mb-8 max-w-2xl mx-auto">
            เปลี่ยนรูปโปรไฟล์ของคุณให้โดดเด่นด้วยกรอบรูปภาพพิเศษจาก GAMA Awards อัพโหลดรูปภาพของคุณ เลือกกรอบที่ชอบ และดาวน์โหลดเพื่อใช้เป็นรูปโปรไฟล์ใหม่ของคุณ
        </p>

        <div class="mb-8 max-w-xl mx-auto">
            <div class="card p-6">
                <label class="block text-lg font-medium mb-3 text-gray-700">อัพโหลดรูปโปรไฟล์ของคุณ:</label>
                <div class="file-upload">
                    <button id="uploadBtn" class="w-full bg-gradient-to-r from-purple-800 to-pink-600 hover:from-purple-700 hover:to-pink-500 text-white py-3 px-6 rounded-lg font-medium flex items-center justify-center btn">
                        เลือกรูปภาพจากเครื่อง
                    </button>
                    <input type="file" id="imageUpload" accept="image/*">
                </div>
                <p id="selectedFileName" class="mt-2 text-center text-sm text-gray-500"></p>
            </div>
        </div>

        <div class="mb-8">
            <h2 class="text-xl font-medium mb-4 text-center text-white">เลือกกรอบรูปภาพ</h2>
            <div class="flex flex-wrap justify-center gap-3">
                <div class="frame-option rounded-lg" data-frame="MAA">
                    <img src="https://hugmediacreation.com/photo/MASTER%20MULTILINE%20Award.png" alt="MAA" class="mx-auto">
                    <p>MAA</p>
                </div>
                <div class="frame-option rounded-lg" data-frame="MFA">
                    <img src="https://hugmediacreation.com/photo/MASTER%20FIRM%20Award.png" alt="MFA" class="mx-auto">
                    <p>MFA</p>
                </div>
                <div class="frame-option rounded-lg" data-frame="MMA">
                    <img src="https://hugmediacreation.com/photo/MASTER%20AGENCY%20Award.png" alt="MMA" class="mx-auto">
                    <p>MMA</p>
                </div>
                <div class="frame-option rounded-lg" data-frame="IMA">
                    <img src="https://hugmediacreation.com/photo/International%20Management%20Award.png" alt="IMA" class="mx-auto">
                    <p>IMA</p>
                </div>
                <div class="frame-option rounded-lg" data-frame="FLA">
                    <img src="https://hugmediacreation.com/photo/Frontline%20Leader%20Awards.png" alt="FLA" class="mx-auto">
                    <p>FLA</p>
                </div>
                <div class="frame-option rounded-lg" data-frame="ERA">
                    <img src="https://hugmediacreation.com/photo/Excellence%20Recruitment%20Award.png" alt="ERA" class="mx-auto">
                    <p>ERA</p>
                </div>
                <div class="frame-option rounded-lg" data-frame="COE">
                    <img src="https://hugmediacreation.com/photo/Circle%20of%20Excellence%20Award.png" alt="COE" class="mx-auto">
                    <p>COE</p>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
            <div class="lg:col-span-2">
                <div class="card p-4">
                    <div id="preview" class="image-container flex items-center justify-center">
                        <div id="placeholderText" class="text-center p-4 absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mx-auto mb-2 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 0 00-2 2v12a2 2 0 002 2z" />
                            </svg>
                            <p class="text-gray-500">โปรดอัพโหลดรูปภาพและเลือกกรอบ</p>
                        </div>
                        <img id="userImage" class="user-image hidden" src="" alt="User uploaded image">
                        <img id="frameImage" class="frame-image hidden" src="" alt="Selected frame">
                    </div>
                </div>
            </div>

            <div class="card p-6">
                <h3 class="text-lg font-medium mb-4 text-gray-700">ปรับแต่งรูปภาพ</h3>

                <div class="mb-4">
                    <label for="scaleSlider" class="block text-sm font-medium mb-1 text-gray-600">ขนาด:</label>
                    <input type="range" id="scaleSlider" class="slider w-full" min="50" max="300" value="100">
                    <div class="flex justify-between text-xs text-gray-500">
                        <span>เล็ก</span>
                        <span>ใหญ่</span>
                    </div>
                </div>

                <div class="mb-4">
                    <label for="xPosSlider" class="block text-sm font-medium mb-1 text-gray-600">ตำแหน่งแนวนอน:</label>
                    <input type="range" id="xPosSlider" class="slider w-full" min="-100" max="100" value="0">
                    <div class="flex justify-between text-xs text-gray-500">
                        <span>ซ้าย</span>
                        <span>ขวา</span>
                    </div>
                </div>

                <div class="mb-6">
                    <label for="yPosSlider" class="block text-sm font-medium mb-1 text-gray-600">ตำแหน่งแนวตั้ง:</label>
                    <input type="range" id="yPosSlider" class="slider w-full" min="-100" max="100" value="0">
                    <div class="flex justify-between text-xs text-gray-500">
                        <span>บน</span>
                        <span>ล่าง</span>
                    </div>
                </div>

                <button id="downloadBtn" class="w-full bg-gradient-to-r from-purple-800 to-pink-600 hover:from-purple-700 hover:to-pink-500 text-white py-3 px-6 rounded-lg font-medium flex items-center justify-center btn disabled:opacity-50 disabled:cursor-not-allowed mb-3" disabled>
                    ดาวน์โหลดรูปโปรไฟล์
                </button>
                
                <button id="shareBtn" class="w-full bg-gradient-to-r from-blue-600 to-blue-400 hover:from-blue-500 hover:to-blue-300 text-white py-3 px-6 rounded-lg font-medium flex items-center justify-center btn disabled:opacity-50 disabled:cursor-not-allowed mt-3" disabled>
                    แชร์รูปโปรไฟล์
                </button>

                <p class="mt-4 text-sm text-gray-500 text-center">ดาวน์โหลดและใช้เป็นรูปโปรไฟล์ของคุณบนโซเชียลมีเดีย</p>
            </div>
        </div>

        <div class="text-center text-sm text-gray-500 mt-8 mb-4">
            © GAMA Awards 2025 - ระบบใส่กรอบรูปภาพ
        </div>
    </div>

    <div id="loadingOverlay" class="loading hidden">
        <div class="spinner"></div>
        <span>กำลังประมวลผล...</span>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // --- DOM Elements ---
            const imageUpload = document.getElementById('imageUpload');
            const uploadBtn = document.getElementById('uploadBtn');
            const selectedFileName = document.getElementById('selectedFileName');
            const frameOptions = document.querySelectorAll('.frame-option');
            const userImagePreview = document.getElementById('userImage');
            const frameImagePreview = document.getElementById('frameImage');
            const placeholderText = document.getElementById('placeholderText');
            const scaleSlider = document.getElementById('scaleSlider');
            const xPosSlider = document.getElementById('xPosSlider');
            const yPosSlider = document.getElementById('yPosSlider');
            const downloadBtn = document.getElementById('downloadBtn');
            const shareBtn = document.getElementById('shareBtn');
            const loadingOverlay = document.getElementById('loadingOverlay');
            const previewContainer = document.getElementById('preview');

            // --- Frame URLs Mapping ---
            const frameUrls = {
                'MAA': 'https://hugmediacreation.com/photo/MASTER%20MULTILINE%20Award.png',
                'MFA': 'https://hugmediacreation.com/photo/MASTER%20FIRM%20Award.png',
                'MMA': 'https://hugmediacreation.com/photo/MASTER%20AGENCY%20Award.png',
                'IMA': 'https://hugmediacreation.com/photo/International%20Management%20Award.png',
                'FLA': 'https://hugmediacreation.com/photo/Frontline%20Leader%20Awards.png',
                'ERA': 'https://hugmediacreation.com/photo/Excellence%20Recruitment%20Award.png',
                'COE': 'https://hugmediacreation.com/photo/Circle%20of%20Excellence%20Award.png'
            };

            // --- State Variables ---
            let selectedFrame = null;
            let userImageLoaded = false;
            let frameImageLoaded = false;
            let initialTranslateX, initialTranslateY;
            let currentScale = 1;

            // --- Helper Functions ---

            // Checks if both user image and frame are loaded to enable buttons
            function checkButtonAvailability() {
                const isReady = userImageLoaded && selectedFrame !== null && frameImageLoaded;
                downloadBtn.disabled = !isReady;
                shareBtn.disabled = !isReady;
            }

            // Applies transform styles to the user image in the preview
            function updateImagePosition() {
                if (!userImageLoaded) return;

                const scale = parseFloat(scaleSlider.value) / 100;
                const xPos = parseFloat(xPosSlider.value);
                const yPos = parseFloat(yPosSlider.value);

                currentScale = scale;
                initialTranslateX = xPos;
                initialTranslateY = yPos;

                userImagePreview.style.transform = `translate(${initialTranslateX}%, ${initialTranslateY}%) scale(${currentScale})`;
            }

            // --- Event Listeners ---

            uploadBtn.addEventListener('click', function() {
                imageUpload.click();
            });

            imageUpload.addEventListener('change', function(event) {
                if (event.target.files && event.target.files[0]) {
                    const file = event.target.files[0];
                    if (!file.type.startsWith('image/')) {
                        alert('กรุณาเลือกไฟล์รูปภาพเท่านั้น');
                        resetImageUpload();
                        return;
                    }

                    selectedFileName.textContent = file.name;

                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const img = new Image();
                        img.onload = function() {
                            userImagePreview.src = img.src;
                            placeholderText.classList.add('hidden');
                            userImagePreview.classList.remove('hidden');
                            userImageLoaded = true;
                            // Reset sliders and transform when a new image is loaded
                            scaleSlider.value = 100;
                            xPosSlider.value = 0;
                            yPosSlider.value = 0;
                            updateImagePosition(); // Apply default positions
                            checkButtonAvailability();
                        };
                        img.onerror = function() {
                            alert('เกิดข้อผิดพลาดในการโหลดรูปภาพของคุณ กรุณาลองใหม่ (ไฟล์อาจเสียหายหรือไม่ใช่รูปภาพ)');
                            resetImageUpload();
                        };
                        img.src = e.target.result;
                    };
                    reader.onerror = function() {
                        alert('เกิดข้อผิดพลาดในการอ่านไฟล์รูปภาพ กรุณาลองใหม่');
                        resetImageUpload();
                    };
                    reader.readAsDataURL(file);
                } else {
                    resetImageUpload();
                }
            });

            function resetImageUpload() {
                selectedFileName.textContent = '';
                userImagePreview.classList.add('hidden');
                userImagePreview.src = '';
                placeholderText.classList.remove('hidden');
                userImageLoaded = false;
                checkButtonAvailability();
            }

            frameOptions.forEach(option => {
                option.addEventListener('click', function() {
                    const frameId = this.dataset.frame;

                    frameOptions.forEach(opt => opt.classList.remove('selected'));
                    this.classList.add('selected');

                    selectedFrame = frameId;

                    frameImagePreview.onload = function() {
                        frameImagePreview.classList.remove('hidden');
                        frameImageLoaded = true;
                        checkButtonAvailability();
                    };
                    frameImagePreview.onerror = function() {
                        console.error('Failed to load frame image:', frameUrls[frameId]);
                        alert('เกิดข้อผิดพลาดในการโหลดกรอบรูป กรุณาตรวจสอบลิงก์รูปภาพกรอบอีกครั้ง หรือรูปภาพอาจถูกลบไปแล้ว');
                        frameImageLoaded = false;
                        checkButtonAvailability();
                    };
                    frameImagePreview.src = frameUrls[frameId];
                });
            });

            scaleSlider.addEventListener('input', updateImagePosition);
            xPosSlider.addEventListener('input', updateImagePosition);
            yPosSlider.addEventListener('input', updateImagePosition);

            // Function to render the combined image using html2canvas
            async function renderCombinedImage() {
                // Ensure both user image and frame image are fully loaded and rendered in the DOM
                if (!userImageLoaded || !selectedFrame || !frameImageLoaded) {
                    alert('โปรดอัปโหลดรูปภาพและเลือกกรอบก่อนดำเนินการ');
                    return null;
                }

                loadingOverlay.classList.remove('hidden');

                const tempRenderDiv = document.createElement('div');
                tempRenderDiv.style.width = '1920px';
                tempRenderDiv.style.height = '1920px';
                tempRenderDiv.style.position = 'absolute';
                tempRenderDiv.style.left = '-9999px';
                tempRenderDiv.style.top = '-9999px';
                tempRenderDiv.style.overflow = 'hidden';
                tempRenderDiv.style.backgroundColor = 'transparent'; // Use transparent background for PNG
                tempRenderDiv.style.display = 'flex';
                tempRenderDiv.style.alignItems = 'center';
                tempRenderDiv.style.justifyContent = 'center';
                document.body.appendChild(tempRenderDiv);

                const hiResUserImage = new Image();
                const hiResFrameImage = new Image();

                hiResUserImage.src = userImagePreview.src;
                hiResFrameImage.src = frameImagePreview.src;

                // Apply the same transformations (scale, translate) to the high-res user image
                hiResUserImage.style.transform = `translate(${initialTranslateX}%, ${initialTranslateY}%) scale(${currentScale})`;
                hiResUserImage.style.transformOrigin = 'center center';
                hiResUserImage.style.objectFit = 'cover';
                hiResUserImage.style.width = '100%';
                hiResUserImage.style.height = '100%';
                hiResUserImage.style.position = 'absolute';
                hiResUserImage.style.zIndex = '5';
                hiResUserImage.style.display = 'block';

                hiResFrameImage.style.width = '100%';
                hiResFrameImage.style.height = '100%';
                hiResFrameImage.style.position = 'absolute';
                hiResFrameImage.style.zIndex = '10';
                hiResFrameImage.style.objectFit = 'contain';
                hiResFrameImage.style.display = 'block';

                tempRenderDiv.appendChild(hiResUserImage);
                tempRenderDiv.appendChild(hiResFrameImage);

                try {
                    // Wait for both high-res images to load in the temporary div
                    await Promise.all([
                        new Promise(resolve => {
                            if (hiResUserImage.complete && hiResUserImage.naturalWidth > 0) resolve();
                            else { hiResUserImage.onload = resolve; hiResUserImage.onerror = resolve; }
                        }),
                        new Promise(resolve => {
                            if (hiResFrameImage.complete && hiResFrameImage.naturalWidth > 0) resolve();
                            else { hiResFrameImage.onload = resolve; hiResFrameImage.onerror = resolve; }
                        })
                    ]);

                    // Add a slightly longer delay to ensure DOM rendering and image composition
                    await new Promise(r => setTimeout(r, 250)); // Increased from 100ms

                    const canvas = await html2canvas(tempRenderDiv, {
                        width: 1920,
                        height: 1920,
                        scale: 1, // Crucial for exact resolution and preventing unintended scaling
                        backgroundColor: null, // Makes background transparent for PNG
                        useCORS: true, // Allow loading cross-origin images (frames)
                        allowTaint: true, // Allow tainted canvas, if CORS is an issue for some frames
                        logging: true,
                        imageTimeout: 20000 // Increased timeout for image loading
                    });
                    return canvas;
                } catch (err) {
                    console.error('Error in renderCombinedImage:', err);
                    alert('เกิดข้อผิดพลาดในการสร้างรูปภาพ กรุณาลองใหม่อีกครั้ง');
                    return null;
                } finally {
                    // Clean up the temporary div after capture or on error
                    if (tempRenderDiv.parentNode) {
                        document.body.removeChild(tempRenderDiv);
                    }
                    loadingOverlay.classList.add('hidden');
                }
            }


            // --- Download Functionality ---
            downloadBtn.addEventListener('click', async function() {
                const canvas = await renderCombinedImage();
                if (canvas) {
                    try {
                        const link = document.createElement('a');
                        link.download = `profile-${selectedFrame}-gama-awards.png`;
                        link.href = canvas.toDataURL('image/png');
                        link.click();
                    } catch (e) {
                        console.error('Error creating data URL or download link:', e);
                        alert('ไม่สามารถดาวน์โหลดรูปภาพได้ (อาจเกิดจากปัญหาภายในหรือรูปภาพต้นฉบับเสียหาย)');
                    }
                }
            });

            // --- Share Functionality ---
            shareBtn.addEventListener('click', async function() {
                const canvas = await renderCombinedImage();
                if (canvas) {
                    canvas.toBlob(async blob => {
                        const file = new File([blob], `profile-${selectedFrame}-gama-awards.png`, {type: "image/png"});

                        // Try to use Web Share API first
                        if (navigator.share && navigator.canShare({ files: [file] })) {
                            try {
                                await navigator.share({
                                    files: [file],
                                    title: 'รูปโปรไฟล์ GAMA Awards',
                                    text: `สร้างรูปโปรไฟล์ GAMA Awards ของฉันด้วยกรอบ ${selectedFrame}!`
                                });
                                console.log('รูปถูกแชร์แล้วผ่าน Web Share API');
                            } catch (error) {
                                console.error('Error sharing via Web Share API:', error);
                                // Fallback to clipboard if share fails (e.g., user cancels share dialog)
                                tryClipboardShare(file);
                            }
                        } else if (navigator.clipboard && navigator.clipboard.write) {
                            // Fallback to clipboard if Web Share API is not available
                            tryClipboardShare(file);
                        } else {
                            alert("อุปกรณ์ของคุณไม่รองรับการแชร์รูปภาพโดยตรง กรุณาดาวน์โหลดแล้วแชร์ด้วยตนเอง");
                        }
                    }, 'image/png'); // Specify MIME type for toBlob
                }
            });

            // Helper function for clipboard sharing fallback
            async function tryClipboardShare(file) {
                const item = [new ClipboardItem({[file.type]: file})];
                try {
                    await navigator.clipboard.write(item);
                    alert("คัดลอกรูปภาพแล้ว! คุณสามารถเปิด Line/Messenger และวาง (Ctrl+V หรือแตะค้าง -> วาง) ได้เลย");
                    console.log('รูปถูกคัดลอกไปยัง Clipboard แล้ว');
                } catch (error) {
                    console.error('Error copying to clipboard:', error);
                    alert("ไม่สามารถคัดลอกรูปภาพได้ กรุณาใช้ปุ่มดาวน์โหลดแล้วแชร์ด้วยตนเอง");
                }
            }

            // --- Initial Setup ---
            updateImagePosition(); // Set initial position based on slider defaults
            checkButtonAvailability(); // Check initial state for download and share buttons
        });
    </script>
</body>
</html>
