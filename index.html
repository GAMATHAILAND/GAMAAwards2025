<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GAMA Awards Frame Creator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-purple: #8A2BE2; /* Amethyst */
            --dark-pink: #C71585; /* MediumVioletRed */
            --light-gray: #f0f0f0;
            --dark-gray: #333;
            --white: #fff;
        }

        body {
            font-family: 'Prompt', sans-serif;
            min-height: 100vh;
            color: var(--dark-gray);
            /* Background gradient from purple (bottom) to dark pink (top) */
            background: linear-gradient(to top, var(--primary-purple), var(--dark-pink));
        }

        .frame-option {
            transition: all 0.3s ease;
            cursor: pointer;
            background-color: var(--white);
            border: 1px solid #e5e7eb;
            display: flex; /* Flexbox for centering content */
            flex-direction: column; /* Stack image and text */
            align-items: center; /* Center horizontally */
            justify-content: center; /* Center vertically */
            padding: 8px; /* Reduced padding */
        }

        .frame-option:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        .frame-option.selected {
            border: 3px solid var(--primary-purple); /* Stronger border for selected */
            transform: translateY(-5px);
            box-shadow: 0 8px 12px -2px rgba(0, 0, 0, 0.15); /* Slightly stronger shadow */
        }
        
        .frame-option img {
            width: 60px; /* Smaller preview images for frames */
            height: 60px;
        }

        /* Adjusted image-container for responsiveness */
        .image-container {
            position: relative;
            width: 100%;
            padding-top: 100%; /* 1:1 Aspect Ratio (height equals width) */
            overflow: hidden;
            margin: 0 auto;
            background-color: var(--light-gray); /* Match earlier minimal design */
            border: 2px dashed var(--primary-purple); /* Border to match overall theme */
            border-radius: 8px;
            cursor: grab; /* Indicates draggable */
        }
        .image-container:active {
            cursor: grabbing;
        }

        .image-container > img {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: contain; /* Use contain to show entire image initially */
            pointer-events: none; /* Allows dragging through to the user image */
        }

        /* user-image and frame-image styles */
        .user-image {
            transform-origin: center;
            object-fit: cover; /* Ensures the image covers the area *before* transform */
            /* Initial transform will be applied via JS */
            will-change: transform; /* Hint for browser performance */
        }

        .frame-image {
            pointer-events: none; /* Allows clicks to pass through */
            z-index: 10; /* Ensures frame is on top of user image */
        }

        .slider {
            -webkit-appearance: none;
            height: 8px;
            border-radius: 4px;
            background: var(--light-gray);
            outline: none;
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--primary-purple); /* Match primary theme color */
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        .slider::-webkit-slider-thumb:hover {
            background-color: var(--dark-pink);
        }

        .slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--primary-purple);
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        .slider::-moz-range-thumb:hover {
            background-color: var(--dark-pink);
        }

        .btn {
            transition: all 0.3s ease;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            color: white;
            font-size: 24px;
        }

        .spinner {
            border: 5px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 5px solid white;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }

        .card {
            background-color: var(--white);
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        .file-upload {
            position: relative;
            overflow: hidden;
            display: inline-block;
            width: 100%;
        }

        .file-upload input[type=file] {
            position: absolute;
            top: 0;
            right: 0;
            min-width: 100%;
            min-height: 100%;
            font-size: 100px;
            text-align: right;
            filter: alpha(opacity=0);
            opacity: 0;
            outline: none;
            cursor: pointer;
            display: block;
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .container {
                padding-left: 1rem;
                padding-right: 1rem;
            }
            .h-24 {
                height: 5rem; /* Smaller logo on mobile */
            }
            .text-3xl {
                font-size: 2rem;
            }
            .text-xl {
                font-size: 1.5rem;
            }
            .frame-option img {
                width: 48px;
                height: 48px;
            }
            .frame-option p {
                font-size: 0.8em;
            }
            .grid-cols-1 .lg\:col-span-2 {
                grid-column: span 1 / span 1;
            }
            .card {
                padding: 1rem;
            }
        }
    </style>
</head>
<body class="min-h-screen">
    <div class="header-gradient" style="background: linear-gradient(to right, var(--primary-purple), var(--dark-pink)); height: 8px;"></div>
    <div class="container mx-auto px-4 py-8">
        <div class="flex justify-center mb-6">
            <img src="https://hugmediacreation.com/wp-content/uploads/2025/06/logo-gama-awards.png" alt="GAMA Awards Logo" class="h-24">
        </div>
        <h1 class="text-3xl font-bold text-center text-gray-800 mb-4">GAMA Awards Frame</h1>
        <p class="text-center text-gray-600 mb-8 max-w-2xl mx-auto">เปลี่ยนรูปโปรไฟล์ของคุณให้โดดเด่นด้วยกรอบรูปภาพพิเศษจาก GAMA Awards อัพโหลดรูปภาพของคุณ เลือกกรอบที่ชอบ และดาวน์โหลดเพื่อใช้เป็นรูปโปรไฟล์ใหม่ของคุณ</p>

        <div class="mb-8 max-w-xl mx-auto">
            <div class="card p-6">
                <label class="block text-lg font-medium mb-3 text-gray-700">อัพโหลดรูปโปรไฟล์ของคุณ:</label>
                <div class="file-upload">
                    <button id="uploadBtn" class="w-full bg-gradient-to-r from-purple-800 to-pink-600 hover:from-purple-700 hover:to-pink-500 text-white py-3 px-6 rounded-lg font-medium flex items-center justify-center btn">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 0 003 3h10a3 0 003-3v-1m-4-8l-4-4m0 0l-4 4m4-4v12" />
                        </svg>
                        เลือกรูปภาพจากเครื่อง
                    </button>
                    <input type="file" id="imageUpload" accept="image/*">
                </div>
                <p id="selectedFileName" class="mt-2 text-center text-sm text-gray-500"></p>
            </div>
        </div>

        <div class="mb-8">
            <h2 class="text-xl font-medium mb-4 text-center text-gray-700">เลือกกรอบรูปภาพ</h2>
            <div class="flex flex-wrap justify-center gap-3">
                <div class="frame-option rounded-lg text-center" data-frame="MAA">
                    <img src="https://hugmediacreation.com/photo/MASTER%20MULTILINE%20Award.png" alt="MAA" class="object-contain mx-auto">
                    <p class="text-sm font-medium mt-1 text-gray-800">MAA</p>
                </div>
                <div class="frame-option rounded-lg text-center" data-frame="MFA">
                    <img src="https://hugmediacreation.com/photo/MASTER%20FIRM%20Award.png" alt="MFA" class="object-contain mx-auto">
                    <p class="text-sm font-medium mt-1 text-gray-800">MFA</p>
                </div>
                <div class="frame-option rounded-lg text-center" data-frame="MMA">
                    <img src="https://hugmediacreation.com/photo/MASTER%20AGENCY%20Award.png" alt="MMA" class="object-contain mx-auto">
                    <p class="text-sm font-medium mt-1 text-gray-800">MMA</p>
                </div>
                <div class="frame-option rounded-lg text-center" data-frame="IMA">
                    <img src="https://hugmediacreation.com/photo/International%20Management%20Award.png" alt="IMA" class="object-contain mx-auto">
                    <p class="text-sm font-medium mt-1 text-gray-800">IMA</p>
                </div>
                <div class="frame-option rounded-lg text-center" data-frame="FLA">
                    <img src="https://hugmediacreation.com/photo/Frontline%20Leader%20Awards.png" alt="FLA" class="object-contain mx-auto">
                    <p class="text-sm font-medium mt-1 text-gray-800">FLA</p>
                </div>
                <div class="frame-option rounded-lg text-center" data-frame="ERA">
                    <img src="https://hugmediacreation.com/photo/Excellence%20Recruitment%20Award.png" alt="ERA" class="object-contain mx-auto">
                    <p class="text-sm font-medium mt-1 text-gray-800">ERA</p>
                </div>
                <div class="frame-option rounded-lg text-center" data-frame="COE">
                    <img src="https://hugmediacreation.com/photo/Circle%20of%20Excellence%20Award.png" alt="COE" class="object-contain mx-auto">
                    <p class="text-sm font-medium mt-1 text-gray-800">COE</p>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
            <div class="lg:col-span-2">
                <div class="card p-4">
                    <div id="preview" class="image-container flex items-center justify-center">
                        <div id="placeholderText" class="text-center p-4 absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mx-auto mb-2 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 0 00-2 2v12a2 2 0 002 2z" />
                            </svg>
                            <p class="text-gray-500">โปรดอัพโหลดรูปภาพและเลือกกรอบ</p>
                        </div>
                        <img id="userImage" class="user-image absolute hidden" src="" alt="User uploaded image" style="top: 0; left: 0; width: 100%; height: 100%;">
                        <img id="frameImage" class="frame-image absolute hidden" src="" alt="Selected frame" style="top: 0; left: 0; width: 100%; height: 100%;">
                    </div>
                </div>
            </div>

            <div class="card p-6">
                <h3 class="text-lg font-medium mb-4 text-gray-700">ปรับแต่งรูปภาพ</h3>

                <div class="mb-4">
                    <label for="scaleSlider" class="block text-sm font-medium mb-1 text-gray-600">ขนาด:</label>
                    <input type="range" id="scaleSlider" class="slider w-full" min="50" max="300" value="100">
                    <div class="flex justify-between text-xs text-gray-500">
                        <span>เล็ก</span>
                        <span>ใหญ่</span>
                    </div>
                </div>

                <div class="mb-4">
                    <label for="xPosSlider" class="block text-sm font-medium mb-1 text-gray-600">ตำแหน่งแนวนอน:</label>
                    <input type="range" id="xPosSlider" class="slider w-full" min="-100" max="100" value="0">
                    <div class="flex justify-between text-xs text-gray-500">
                        <span>ซ้าย</span>
                        <span>ขวา</span>
                    </div>
                </div>

                <div class="mb-6">
                    <label for="yPosSlider" class="block text-sm font-medium mb-1 text-gray-600">ตำแหน่งแนวตั้ง:</label>
                    <input type="range" id="yPosSlider" class="slider w-full" min="-100" max="100" value="0">
                    <div class="flex justify-between text-xs text-gray-500">
                        <span>บน</span>
                        <span>ล่าง</span>
                    </div>
                </div>

                <button id="downloadBtn" class="w-full bg-gradient-to-r from-purple-800 to-pink-600 hover:from-purple-700 hover:to-pink-500 text-white py-3 px-6 rounded-lg font-medium flex items-center justify-center btn disabled:opacity-50 disabled:cursor-not-allowed mb-3" disabled>
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 0 003 3h10a3 0 003-3v-1m-4-8l-4-4m0 0l-4 4m4-4v12" />
                    </svg>
                    ดาวน์โหลดรูปโปรไฟล์
                </button>

                <p class="mt-4 text-sm text-gray-500 text-center">ดาวน์โหลดและใช้เป็นรูปโปรไฟล์ของคุณบนโซเชียลมีเดีย</p>
            </div>
        </div>

        <div class="text-center text-sm text-gray-500 mb-8">
            © GAMA Awards 2025 - ระบบใส่กรอบรูปภาพ
        </div>
    </div>

    <div id="loadingOverlay" class="loading hidden">
        <div class="spinner"></div>
        <span>กำลังประมวลผล...</span>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Elements
            const imageUpload = document.getElementById('imageUpload');
            const uploadBtn = document.getElementById('uploadBtn');
            const selectedFileName = document.getElementById('selectedFileName');
            const frameOptions = document.querySelectorAll('.frame-option');
            const userImagePreview = document.getElementById('userImage');
            const frameImagePreview = document.getElementById('frameImage');
            const placeholderText = document.getElementById('placeholderText');
            const scaleSlider = document.getElementById('scaleSlider');
            const xPosSlider = document.getElementById('xPosSlider');
            const yPosSlider = document.getElementById('yPosSlider');
            const downloadBtn = document.getElementById('downloadBtn');
            const loadingOverlay = document.getElementById('loadingOverlay');
            const previewContainer = document.getElementById('preview'); // The image-container div

            // Frame URLs (UPDATED TO EXTERNAL URLs)
            const frameUrls = {
                'MAA': 'https://hugmediacreation.com/photo/MASTER%20MULTILINE%20Award.png',
                'MFA': 'https://hugmediacreation.com/photo/MASTER%20FIRM%20Award.png',
                'MMA': 'https://hugmediacreation.com/photo/MASTER%20AGENCY%20Award.png',
                'IMA': 'https://hugmediacreation.com/photo/International%20Management%20Award.png',
                'FLA': 'https://hugmediacreation.com/photo/Frontline%20Leader%20Awards.png',
                'ERA': 'https://hugmediacreation.com/photo/Excellence%20Recruitment%20Award.png',
                'COE': 'https://hugmediacreation.com/photo/Circle%20of%20Excellence%20Award.png'
            };

            // State
            let selectedFrame = null;
            let userImageLoaded = false;
            let frameImageLoaded = false;
            let isDragging = false;
            let startX, startY;
            let currentTranslateX = 0;
            let currentTranslateY = 0;
            let currentScale = 1;

            // Function to check if both images are loaded for download enablement
            function checkDownloadAvailability() {
                downloadBtn.disabled = !(userImageLoaded && selectedFrame && frameImageLoaded);
            }

            // --- Event Listeners ---

            // Trigger file input when the upload button is clicked
            uploadBtn.addEventListener('click', function() {
                imageUpload.click();
            });

            // Handle file upload
            imageUpload.addEventListener('change', function() {
                if (this.files && this.files[0]) {
                    const file = this.files[0];
                    selectedFileName.textContent = file.name;

                    const reader = new FileReader();
                    reader.onload = function(e) {
                        userImagePreview.onload = function() {
                            placeholderText.classList.add('hidden');
                            userImagePreview.classList.remove('hidden');
                            userImageLoaded = true;
                            // Reset sliders and transform when a new image is loaded
                            scaleSlider.value = 100;
                            xPosSlider.value = 0;
                            yPosSlider.value = 0;
                            currentTranslateX = 0;
                            currentTranslateY = 0;
                            currentScale = 1;
                            updateImagePosition(); // Apply default positions for preview
                            checkDownloadAvailability();
                        };
                        userImagePreview.onerror = function() {
                            alert('เกิดข้อผิดพลาดในการโหลดรูปภาพของคุณ กรุณาลองใหม่');
                            userImageLoaded = false;
                            checkDownloadAvailability();
                        };
                        userImagePreview.src = e.target.result;
                    };
                    reader.readAsDataURL(file);
                } else {
                    selectedFileName.textContent = '';
                    userImagePreview.classList.add('hidden');
                    placeholderText.classList.remove('hidden');
                    userImageLoaded = false;
                    checkDownloadAvailability();
                }
            });

            // Select frame
            frameOptions.forEach(option => {
                option.addEventListener('click', function() {
                    const frameId = this.dataset.frame;

                    frameOptions.forEach(opt => opt.classList.remove('selected'));
                    this.classList.add('selected');

                    selectedFrame = frameId;

                    // Load frame image for preview and set frameImageLoaded flag
                    frameImagePreview.onload = function() {
                        frameImagePreview.classList.remove('hidden');
                        frameImageLoaded = true;
                        checkDownloadAvailability();
                    };
                    frameImagePreview.onerror = function() {
                        console.error('Failed to load frame image:', frameUrls[frameId]);
                        alert('เกิดข้อผิดพลาดในการโหลดกรอบรูป กรุณาตรวจสอบลิงก์รูปภาพกรอบอีกครั้ง');
                        frameImageLoaded = false;
                        checkDownloadAvailability();
                    };
                    frameImagePreview.src = frameUrls[frameId];
                });
            });

            // Update image position and scale for the PREVIEW
            function updateImagePosition() {
                if (!userImageLoaded) return;

                const scale = parseFloat(scaleSlider.value) / 100;
                currentScale = scale; // Update currentScale from slider
                
                // Translate values are now directly used for preview
                currentTranslateX = parseFloat(xPosSlider.value);
                currentTranslateY = parseFloat(yPosSlider.value);

                userImagePreview.style.transform = `translate(${currentTranslateX}%, ${currentTranslateY}%) scale(${currentScale})`;
            }

            // Event listeners for sliders
            scaleSlider.addEventListener('input', updateImagePosition);
            xPosSlider.addEventListener('input', updateImagePosition);
            yPosSlider.addEventListener('input', updateImagePosition);

            // --- Dragging functionality ---
            previewContainer.addEventListener('mousedown', (e) => {
                if (userImageLoaded && selectedFrame) {
                    isDragging = true;
                    // Prevent image from being dragged as a ghost image
                    e.preventDefault();
                    // Calculate click position relative to the image's current transformed position
                    const rect = userImagePreview.getBoundingClientRect();
                    startX = e.clientX - rect.left - (rect.width / 2);
                    startY = e.clientY - rect.top - (rect.height / 2);
                    
                    // Store the initial slider values at the start of the drag
                    // These will be modified relative to their initial values
                    startXPos = parseFloat(xPosSlider.value);
                    startYPos = parseFloat(yPosSlider.value);
                    previewContainer.style.cursor = 'grabbing';
                }
            });

            previewContainer.addEventListener('mousemove', (e) => {
                if (!isDragging || !userImageLoaded) return;
                
                const rect = userImagePreview.getBoundingClientRect();
                const deltaX = e.clientX - (rect.left + rect.width / 2) - startX;
                const deltaY = e.clientY - (rect.top + rect.height / 2) - startY;
                
                // Calculate new slider values based on drag distance
                // The factor 200 below converts pixels to percentage for slider range -100 to 100
                const newXPos = startXPos + (deltaX / previewContainer.offsetWidth) * 200;
                const newYPos = startYPos + (deltaY / previewContainer.offsetHeight) * 200;

                xPosSlider.value = Math.max(-100, Math.min(100, newXPos));
                yPosSlider.value = Math.max(-100, Math.min(100, newYPos));
                updateImagePosition();
            });

            previewContainer.addEventListener('mouseup', () => {
                isDragging = false;
                previewContainer.style.cursor = 'grab';
            });

            previewContainer.addEventListener('mouseleave', () => {
                isDragging = false;
                previewContainer.style.cursor = 'grab';
            });
            
            // Touch events for mobile dragging
            previewContainer.addEventListener('touchstart', (e) => {
                if (userImageLoaded && selectedFrame && e.touches.length === 1) {
                    isDragging = true;
                    e.preventDefault(); // Prevent scrolling
                    const touch = e.touches[0];
                    const rect = userImagePreview.getBoundingClientRect();
                    startX = touch.clientX - rect.left - (rect.width / 2);
                    startY = touch.clientY - rect.top - (rect.height / 2);

                    startXPos = parseFloat(xPosSlider.value);
                    startYPos = parseFloat(yPosSlider.value);
                    previewContainer.style.cursor = 'grabbing';
                }
            }, { passive: false }); // Use passive: false to allow preventDefault

            previewContainer.addEventListener('touchmove', (e) => {
                if (!isDragging || !userImageLoaded || e.touches.length !== 1) return;
                
                const touch = e.touches[0];
                const rect = userImagePreview.getBoundingClientRect();
                const deltaX = touch.clientX - (rect.left + rect.width / 2) - startX;
                const deltaY = touch.clientY - (rect.top + rect.height / 2) - startY;

                const newXPos = startXPos + (deltaX / previewContainer.offsetWidth) * 200;
                const newYPos = startYPos + (deltaY / previewContainer.offsetHeight) * 200;

                xPosSlider.value = Math.max(-100, Math.min(100, newXPos));
                yPosSlider.value = Math.max(-100, Math.min(100, newYPos));
                updateImagePosition();
            }, { passive: false });

            previewContainer.addEventListener('touchend', () => {
                isDragging = false;
                previewContainer.style.cursor = 'grab';
            });


            // Download functionality using html2canvas
            downloadBtn.addEventListener('click', function() {
                if (!userImageLoaded || !selectedFrame || !frameImageLoaded) {
                    alert('โปรดอัปโหลดรูปภาพและเลือกกรอบก่อนดาวน์โหลด');
                    return;
                }

                loadingOverlay.classList.remove('hidden');

                // Create a temporary div to render the full-resolution image
                const tempRenderDiv = document.createElement('div');
                tempRenderDiv.style.width = '1920px'; // Desired output resolution
                tempRenderDiv.style.height = '1920px'; // Desired output resolution
                tempRenderDiv.style.position = 'absolute';
                tempRenderDiv.style.left = '-9999px'; // Hide it off-screen
                tempRenderDiv.style.top = '-9999px';
                tempRenderDiv.style.overflow = 'hidden';
                tempRenderDiv.style.backgroundColor = 'transparent';
                tempRenderDiv.style.display = 'flex'; // Use flex to layer images
                tempRenderDiv.style.alignItems = 'center';
                tempRenderDiv.style.justifyContent = 'center';
                document.body.appendChild(tempRenderDiv);

                // Create new image elements for the high-res render
                const hiResUserImage = new Image();
                const hiResFrameImage = new Image();

                hiResUserImage.src = userImagePreview.src;
                hiResFrameImage.src = frameImagePreview.src;

                // Apply transformations based on original slider values for the 1920px canvas
                hiResUserImage.style.transform = `translate(${currentTranslateX}%, ${currentTranslateY}%) scale(${currentScale})`;
                hiResUserImage.style.transformOrigin = 'center center';
                hiResUserImage.style.objectFit = 'cover';
                hiResUserImage.style.width = '100%';
                hiResUserImage.style.height = '100%';
                hiResUserImage.style.position = 'absolute'; // Position relative to tempRenderDiv
                hiResUserImage.style.display = 'block';

                hiResFrameImage.style.width = '100%';
                hiResFrameImage.style.height = '100%';
                hiResFrameImage.style.position = 'absolute'; // Position relative to tempRenderDiv
                hiResFrameImage.style.zIndex = '10';
                hiResFrameImage.style.display = 'block';

                tempRenderDiv.appendChild(hiResUserImage);
                tempRenderDiv.appendChild(hiResFrameImage);

                // Wait for images to load in the temporary div
                Promise.all([
                    new Promise(resolve => {
                        if (hiResUserImage.complete) {
                            resolve();
                        } else {
                            hiResUserImage.onload = resolve;
                            hiResUserImage.onerror = () => {
                                console.error('High-res user image load error.');
                                resolve(); // Resolve even on error to avoid blocking
                            };
                        }
                    }),
                    new Promise(resolve => {
                        if (hiResFrameImage.complete) {
                            resolve();
                        } else {
                            hiResFrameImage.onload = resolve;
                            hiResFrameImage.onerror = () => {
                                console.error('High-res frame image load error.');
                                resolve();
                            };
                        }
                    })
                ]).then(() => {
                    html2canvas(tempRenderDiv, {
                        width: 1920,
                        height: 1920,
                        scale: 1, // Render at 1:1 pixel ratio for the 1920x1920 div
                        backgroundColor: null, // Transparent background if not fully covered
                        useCORS: true, // Necessary if images are from different origin
                        allowTaint: false, // Prevents tainted canvas issues, requires useCORS
                        logging: true,
                        imageTimeout: 15000
                    }).then(canvas => {
                        document.body.removeChild(tempRenderDiv);

                        try {
                            const link = document.createElement('a');
                            link.download = `profile-${selectedFrame}-gama-awards.png`;
                            link.href = canvas.toDataURL('image/png');
                            link.click();
                        } catch (e) {
                            console.error('Error creating data URL or download link:', e);
                            alert('ไม่สามารถดาวน์โหลดรูปภาพได้ (อาจเกิดจากปัญหาภายในหรือรูปภาพต้นฉบับเสียหาย)');
                        }

                        loadingOverlay.classList.add('hidden');
                    }).catch(err => {
                        console.error('Error generating image with html2canvas:', err);
                        alert('เกิดข้อผิดพลาดในการสร้างรูปภาพ กรุณาลองใหม่อีกครั้ง');
                        document.body.removeChild(tempRenderDiv);
                        loadingOverlay.classList.add('hidden');
                    });
                }).catch(err => {
                    console.error('Error waiting for high-res images to load:', err);
                    alert('เกิดข้อผิดพลาดในการเตรียมรูปภาพเพื่อดาวน์โหลด กรุณาลองใหม่อีกครั้ง');
                    document.body.removeChild(tempRenderDiv);
                    loadingOverlay.classList.add('hidden');
                });
            });

            // Initialize position on load
            updateImagePosition();
        });
    </script>
</body>
</html>
