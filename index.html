<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>GAMA Awards Frame</title>
  <link rel="icon" href="logo-gama-awards.png" type="image/png" />
  <link rel="icon" href="favicon.ico" type="image/x-icon" />

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script> 
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap');

    body {
      font-family: 'Prompt', sans-serif;
      background-color: white;
      min-height: 100vh;
      color: #333;
    }

    .frame-option {
      transition: all 0.3s ease;
      cursor: pointer;
      background-color: white;
      border: 1px solid #e5e7eb;
    }

    .frame-option:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
    }

    .frame-option.selected {
      border: 3px solid #4500b2;
      transform: translateY(-5px);
    }

    .image-container {
      position: relative;
      width: 600px; /* Base size for preview */
      height: 600px;
      overflow: hidden;
      margin: 0 auto;
      background-color: #f9fafb;
      border: 2px dashed #d1d5db;
      border-radius: 8px;
      /* Ensure square aspect ratio for preview container */
      aspect-ratio: 1 / 1; 
    }

    @media (max-width: 640px) {
      .image-container {
        width: 100%;
        /* Adjusted height for responsiveness while maintaining aspect ratio */
        height: auto; 
      }
    }

    /* user-image and frame-image styles for preview */
    .user-image {
      position: absolute;
      transform-origin: center;
      width: 100%; 
      height: 100%;
      object-fit: contain; /* Keep this for preview to avoid initial squeeze */
      left: 0;
      top: 0;
      /* Initial transform will be applied via JS */
    }

    .frame-image {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      object-fit: contain; /* Ensures the frame image fits without stretching, maintaining its aspect ratio */
      pointer-events: none; /* Allows clicks to pass through */
      z-index: 10; /* Ensures frame is on top of user image */
    }

    .slider {
      -webkit-appearance: none;
      height: 8px;
      border-radius: 4px;
      background: #e5e7eb;
      outline: none;
    }

    .slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: #4500b2;
      cursor: pointer;
    }

    .slider::-moz-range-thumb {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: #4500b2;
      cursor: pointer;
    }

    .btn {
      transition: all 0.3s ease;
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    }

    .loading {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.7);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      color: white;
      font-size: 24px;
    }

    .spinner {
      border: 5px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top: 5px solid white;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin-right: 10px;
    }

    .card {
      background-color: white;
      border-radius: 12px;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    }

    .file-upload {
      position: relative;
      overflow: hidden;
      display: inline-block;
      width: 100%;
    }

    .file-upload input[type=file] {
      position: absolute;
      top: 0;
      right: 0;
      min-width: 100%;
      min-height: 100%;
      font-size: 100px;
      text-align: right;
      filter: alpha(opacity=0);
      opacity: 0;
      outline: none;
      cursor: pointer;
      display: block;
    }

    .header-gradient {
      background: linear-gradient(to right, #4500b2, #d83361);
      height: 8px;
    }

    /* Modal styles */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.7);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      padding: 1rem;
    }

    .modal-content {
      background-color: white;
      padding: 2rem;
      border-radius: 12px;
      max-width: 500px;
      width: 100%;
      position: relative;
      text-align: center;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
    }

    .modal-close-btn {
      position: absolute;
      top: 10px;
      right: 10px;
      background: none;
      border: none;
      font-size: 2rem;
      color: #999;
      cursor: pointer;
      line-height: 1;
    }
    .modal-close-btn:hover {
      color: #333;
    }

    #modalImage {
      max-width: 100%;
      height: auto;
      border: 1px solid #eee;
      border-radius: 8px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body class="min-h-screen">
  <div class="header-gradient"></div>
  <div class="container mx-auto px-4 py-8">
    <div class="flex justify-center mb-6">
      <img src="https://hugmediacreation.com/wp-content/uploads/2025/06/logo-gama-awards.png" alt="GAMA Awards Logo" class="h-24">
    </div>
    <h1 class="text-3xl font-bold text-center text-gray-800 mb-4">GAMA Awards Frame</h1>
    <p class="text-center text-gray-600 mb-8 max-w-2xl mx-auto">เปลี่ยนรูปโปรไฟล์ของคุณให้โดดเด่นด้วยกรอบรูปภาพพิเศษจาก GAMA Awards อัพโหลดรูปภาพของคุณ เลือกกรอบที่ชอบ และดาวน์โหลดเพื่อใช้เป็นรูปโปรไฟล์ใหม่ของคุณ</p>
    
    <div class="mb-8 max-w-xl mx-auto">
      <div class="card p-6">
        <label class="block text-lg font-medium mb-3 text-gray-700">อัพโหลดรูปโปรไฟล์ของคุณ:</label>
        <div class="file-upload">
          <button id="uploadBtn" class="w-full bg-gradient-to-r from-purple-800 to-pink-600 hover:from-purple-700 hover:to-pink-500 text-white py-3 px-6 rounded-lg font-medium flex items-center justify-center btn">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0l-4 4m4-4v12" />
            </svg>
            เลือกรูปภาพจากเครื่อง
          </button>
          <input type="file" id="imageUpload" accept="image/*">
        </div>
        <p id="selectedFileName" class="mt-2 text-center text-sm text-gray-500"></p>
      </div>
    </div>
    
    <div class="mb-8">
      <h2 class="text-xl font-medium mb-4 text-center text-gray-700">เลือกกรอบรูปภาพ</h2>
      <div class="flex flex-wrap justify-center gap-3">
        <div class="frame-option rounded-lg p-2 text-center" data-frame="MAA">
          <img src="./MASTER MULTILINE Award.png" alt="MAA" class="w-20 h-20 object-contain mx-auto">
          <p class="text-sm font-medium mt-1 text-gray-800">MAA</p>
        </div>
        <div class="frame-option rounded-lg p-2 text-center" data-frame="MFA">
          <img src="./MASTER FIRM Award.png" alt="MFA" class="w-20 h-20 object-contain mx-auto">
          <p class="text-sm font-medium mt-1  text-gray-800">MFA</p>
        </div>
        <div class="frame-option rounded-lg p-2 text-center" data-frame="MMA">
          <img src="./MASTER AGENCY Award.png" alt="MMA" class="w-20 h-20 object-contain mx-auto">
          <p class="text-sm font-medium mt-1 text-gray-800">MMA</p>
        </div>
        <div class="frame-option rounded-lg p-2 text-center" data-frame="IMA">
          <img src="./International Management Award.png" alt="IMA" class="w-20 h-20 object-contain mx-auto">
          <p class="text-sm font-medium mt-1 text-gray-800">IMA</p>
        </div>
        <div class="frame-option rounded-lg p-2 text-center" data-frame="FLA">
          <img src="./Frontline Leader Awards.png" alt="FLA" class="w-20 h-20 object-contain mx-auto">
          <p class="text-sm font-medium mt-1 text-gray-800">FLA</p>
        </div>
        <div class="frame-option rounded-lg p-2 text-center" data-frame="ERA">
          <img src="./Excellence Recruitment Award.png" alt="ERA" class="w-20 h-20 object-contain mx-auto">
          <p class="text-sm font-medium mt-1 text-gray-800">ERA</p>
        </div>
        <div class="frame-option rounded-lg p-2 text-center" data-frame="COE">
          <img src="./Circle of Excellence Award.png" alt="COE" class="w-20 h-20 object-contain mx-auto">
          <p class="text-sm font-medium mt-1 text-gray-800">COE</p>
        </div>
      </div>
    </div>
    
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
      <div class="lg:col-span-2">
        <div class="card p-4">
          <div id="preview" class="image-container flex items-center justify-center">
            <div id="placeholderText" class="text-center p-4">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mx-auto mb-2 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
              </svg>
              <p class="text-gray-500">โปรดอัพโหลดรูปภาพและเลือกกรอบ</p>
            </div>
            <img id="userImage" class="user-image hidden" src="" alt="User uploaded image">
            <img id="frameImage" class="frame-image hidden" src="" alt="Selected frame">
          </div>
        </div>
      </div>
      
      <div class="card p-6">
        <h3 class="text-lg font-medium mb-4 text-gray-700">ปรับแต่งรูปภาพ</h3>
        
        <div class="mb-4">
          <label for="scaleSlider" class="block text-sm font-medium mb-1 text-gray-600">ขนาด:</label>
          <input type="range" id="scaleSlider" class="slider w-full" min="50" max="200" value="100">
          <div class="flex justify-between text-xs text-gray-500">
            <span>เล็ก</span>
            <span>ใหญ่</span>
          </div>
        </div>
        
        <div class="mb-4">
          <label for="xPosSlider" class="block text-sm font-medium mb-1 text-gray-600">ตำแหน่งแนวนอน:</label>
          <input type="range" id="xPosSlider" class="slider w-full" min="-100" max="100" value="0">
          <div class="flex justify-between text-xs text-gray-500">
            <span>ซ้าย</span>
            <span>ขวา</span>
          </div>
        </div>
        
        <div class="mb-6">
          <label for="yPosSlider" class="block text-sm font-medium mb-1 text-gray-600">ตำแหน่งแนวตั้ง:</label>
          <input type="range" id="yPosSlider" class="slider w-full" min="-100" max="100" value="0">
          <div class="flex justify-between text-xs text-gray-500">
            <span>บน</span>
            <span>ล่าง</span>
          </div>
        </div>
        
        <button id="downloadBtn" class="w-full bg-gradient-to-r from-purple-800 to-pink-600 hover:from-purple-700 hover:to-pink-500 text-white py-3 px-6 rounded-lg font-medium flex items-center justify-center btn disabled:opacity-50 disabled:cursor-not-allowed mb-3" disabled>
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" />
          </svg>
          ดาวน์โหลดรูปโปรไฟล์
        </button>
        
        <p class="mt-4 text-sm text-gray-500 text-center">ดาวน์โหลดและใช้เป็นรูปโปรไฟล์ของคุณบนโซเชียลมีเดีย</p>
      </div>
    </div>
    
    <div class="text-center text-sm text-gray-500 mb-8">
      © GAMA Awards 2025 - ระบบใส่กรอบรูปภาพ
    </div>
  </div>
  
  <div id="loadingOverlay" class="loading hidden">
    <div class="spinner"></div>
    <span>กำลังประมวลผล...</span>
  </div>

  <div id="imageModal" class="modal-overlay hidden">
    <div class="modal-content">
      <button class="modal-close-btn" id="closeModalBtn">&times;</button>
      <h3 class="text-xl font-bold mb-4 text-gray-800">บันทึกรูปภาพโปรไฟล์ของคุณ</h3>
      <p class="text-gray-700 mb-4">
        **สำหรับมือถือ/แท็บเล็ต:** โปรดกดค้างที่รูปภาพด้านล่าง (Long press) แล้วเลือก **"บันทึกรูปภาพ"** หรือ **"ดาวน์โหลดรูปภาพ"**
      </p>
      <img id="modalImage" src="" alt="Generated Profile Image">
      <button id="downloadModalBtn"
        class="mt-6 bg-gradient-to-r from-purple-800 to-pink-600 hover:from-purple-700 hover:to-pink-500 text-white py-3 px-6 rounded-lg font-medium flex items-center justify-center btn mx-auto"
        style="max-width: 250px;">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
          <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" />
          </svg>
          ดาวน์โหลด (สำหรับเดสก์ท็อป)
      </button>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Elements
      const imageUpload = document.getElementById('imageUpload');
      const uploadBtn = document.getElementById('uploadBtn');
      const selectedFileName = document.getElementById('selectedFileName');
      const frameOptions = document.querySelectorAll('.frame-option');
      const userImagePreview = document.getElementById('userImage'); 
      const frameImagePreview = document.getElementById('frameImage'); 
      const placeholderText = document.getElementById('placeholderText');
      const scaleSlider = document.getElementById('scaleSlider');
      const xPosSlider = document.getElementById('xPosSlider');
      const yPosSlider = document.getElementById('yPosSlider');
      const downloadBtn = document.getElementById('downloadBtn');
      const loadingOverlay = document.getElementById('loadingOverlay');
      const previewContainer = document.getElementById('preview'); // The 600x600px preview container

      // Modal elements
      const imageModal = document.getElementById('imageModal');
      const closeModalBtn = document.getElementById('closeModalBtn');
      const modalImage = document.getElementById('modalImage');
      const downloadModalBtn = document.getElementById('downloadModalBtn');

      // Frame URLs (UPDATED TO LOCAL FILE PATHS - ตรวจสอบให้แน่ใจว่าชื่อไฟล์ตรงกับที่คุณอัปโหลดบน GitHub)
      const frameUrls = {
        'MAA': './MASTER MULTILINE Award.png',
        'MFA': './MASTER FIRM Award.png',
        'MMA': './MASTER AGENCY Award.png',
        'IMA': './International Management Award.png',
        'FLA': './Frontline Leader Awards.png',
        'ERA': './Excellence Recruitment Award.png',
        'COE': './Circle of Excellence Award.png'
      };
      
      // State
      let selectedFrame = null;
      let userImageLoaded = false; 
      let frameImageLoaded = false; 
      
      // Function to check if both images are loaded for download enablement
      function checkDownloadAvailability() {
        downloadBtn.disabled = !(userImageLoaded && selectedFrame && frameImageLoaded);
      }

      // Detect mobile/tablet device
      function isMobileDevice() {
        return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
      }

      // Trigger file input when the upload button is clicked
      uploadBtn.addEventListener('click', function() {
        imageUpload.click();
      });
      
      // Handle file upload
      imageUpload.addEventListener('change', function() {
        if (this.files && this.files[0]) {
          const file = this.files[0];
          selectedFileName.textContent = file.name;
          
          const reader = new FileReader();
          reader.onload = function(e) {
            userImagePreview.onload = function() {
              placeholderText.classList.add('hidden');
              userImagePreview.classList.remove('hidden');
              userImageLoaded = true;
              // Reset sliders to default when a new image is loaded
              scaleSlider.value = 100;
              xPosSlider.value = 0;
              yPosSlider.value = 0;
              updateImagePosition(); // Apply default positions for preview
              checkDownloadAvailability();
            };
            userImagePreview.onerror = function() {
              alert('เกิดข้อผิดพลาดในการโหลดรูปภาพของคุณ กรุณาลองใหม่');
              userImageLoaded = false;
              checkDownloadAvailability();
            };
            userImagePreview.src = e.target.result;
          };
          reader.readAsDataURL(file);
        } else {
          selectedFileName.textContent = ''; 
          userImagePreview.classList.add('hidden');
          placeholderText.classList.remove('hidden');
          userImageLoaded = false;
          checkDownloadAvailability();
        }
      });
      
      // Select frame
      frameOptions.forEach(option => {
        option.addEventListener('click', function() {
          const frameId = this.dataset.frame;
          
          frameOptions.forEach(opt => opt.classList.remove('selected'));
          this.classList.add('selected');
          
          selectedFrame = frameId;
          
          // Load frame image for preview and set frameImageLoaded flag
          frameImagePreview.onload = function() {
            frameImagePreview.classList.remove('hidden');
            frameImageLoaded = true;
            checkDownloadAvailability();
          };
          frameImagePreview.onerror = function() {
            console.error('Failed to load frame image:', frameUrls[frameId]);
            alert('เกิดข้อผิดพลาดในการโหลดกรอบรูป กรุณาตรวจสอบว่าไฟล์รูปภาพกรอบอยู่ในโฟลเดอร์เดียวกันกับไฟล์ HTML นี้แล้ว และชื่อไฟล์ตรงกัน');
            frameImageLoaded = false;
            checkDownloadAvailability();
          };
          frameImagePreview.src = frameUrls[frameId];
        });
      });
      
      // Update image position and scale for the PREVIEW
      function updateImagePosition() {
        if (!userImageLoaded) return; 
        
        const scale = scaleSlider.value / 100;
        const xPos = parseFloat(xPosSlider.value);
        const yPos = parseFloat(yPosSlider.value);
        
        userImagePreview.style.transform = `translate(${xPos}px, ${yPos}px) scale(${scale})`;
      }
      
      // Event listeners for sliders
      scaleSlider.addEventListener('input', updateImagePosition);
      xPosSlider.addEventListener('input', updateImagePosition);
      yPosSlider.addEventListener('input', updateImagePosition);
      
      // Download functionality using html2canvas
      downloadBtn.addEventListener('click', function() {
        if (!userImageLoaded || !selectedFrame || !frameImageLoaded) {
          alert('โปรดอัปโหลดรูปภาพและเลือกกรอบก่อนดาวน์โหลด');
          return;
        }

        loadingOverlay.classList.remove('hidden');
        
        // Use a temporary div to render the full-resolution image
        const tempRenderDiv = document.createElement('div');
        tempRenderDiv.style.cssText = `
            width: 1920px;
            height: 1920px;
            position: absolute;
            left: -9999px;
            top: -9999px;
            overflow: hidden;
            background-color: transparent;
            display: block;
            box-sizing: border-box; /* Crucial for correct box model */
        `;
        document.body.appendChild(tempRenderDiv);

        // Create new image elements for the high-res render
        const hiResUserImage = new Image();
        const hiResFrameImage = new Image();

        hiResUserImage.src = userImagePreview.src;
        hiResFrameImage.src = frameImagePreview.src;

        // Wait for high-res images to load before proceeding
        Promise.all([
            new Promise((resolve, reject) => {
                hiResUserImage.onload = resolve;
                hiResUserImage.onerror = reject;
                if (hiResUserImage.complete) resolve();
            }),
            new Promise((resolve, reject) => {
                hiResFrameImage.onload = resolve;
                hiResFrameImage.onerror = reject;
                if (hiResFrameImage.complete) resolve();
            })
        ]).then(() => {
            const tempDivSize = 1920; // Target size for the high-res image
            const previewContainerSize = previewContainer.offsetWidth; // Get the actual rendered width of the preview container (e.g., 600px)

            // Get the current transformed state of the user image in the preview
            const userImageRect = userImagePreview.getBoundingClientRect();
            
            // Calculate the current displayed dimensions and position relative to its parent (image-container)
            // Note: userImagePreview.style.width/height is 100%, so we need to calculate effective size based on object-fit and scale
            const naturalWidth = hiResUserImage.naturalWidth;
            const naturalHeight = hiResUserImage.naturalHeight;

            let baseImageWidth = previewContainerSize;
            let baseImageHeight = previewContainerSize;

            if (naturalWidth && naturalHeight) {
                const aspectRatio = naturalWidth / naturalHeight;
                if (aspectRatio > 1) { // Landscape
                    baseImageHeight = previewContainerSize / aspectRatio;
                } else { // Portrait or Square
                    baseImageWidth = previewContainerSize * aspectRatio;
                }
            }

            // Get current scale and translation values from sliders
            const currentScale = parseFloat(scaleSlider.value) / 100;
            const currentXPos = parseFloat(xPosSlider.value);
            const currentYPos = parseFloat(yPosSlider.value);

            // Scale factor from preview size to high-res size
            const renderScaleFactor = tempDivSize / previewContainerSize;

            // Calculate the user image's effective size in the high-res context
            const hiResUserImageEffectiveWidth = baseImageWidth * currentScale * renderScaleFactor;
            const hiResUserImageEffectiveHeight = baseImageHeight * currentScale * renderScaleFactor;

            // Calculate initial offset (if image was centered by object-fit: contain in preview)
            // This is the offset from the top-left of the preview container if the image were unscaled and centered
            const initialOffsetX = (previewContainerSize - baseImageWidth) / 2;
            const initialOffsetY = (previewContainerSize - baseImageHeight) / 2;

            // Calculate the final translation needed for the hi-res image
            // This needs to map the transformed position from the 600px preview to the 1920px canvas
            // The `xPos` and `yPos` from sliders are relative to the center of the 600px container.
            // We need to apply these as an offset from the initially calculated centered position in the 1920px container.
            
            // First, calculate the image's original position relative to preview container's top-left (before user drag/scale)
            // If the image was originally fitted with object-fit: contain, it might not fill the 600x600 space.
            // Its top-left would be at (initialOffsetX, initialOffsetY)
            
            // Then, apply the user's transformations (xPos, yPos from sliders)
            // The slider values (-100 to 100) are relative to the 600px preview.
            // So, translate values from sliders need to be scaled up.
            const scaledXTranslation = currentXPos * renderScaleFactor; // e.g., 100px on 600px preview = 320px on 1920px render
            const scaledYTranslation = currentYPos * renderScaleFactor;

            // Calculate hi-res image's position (left, top) relative to the tempRenderDiv's top-left (0,0)
            // The image's effective top-left after scaling and translating for high-res render.
            // Start from the center of the high-res div, then shift by half of the effective image size (for center transform origin),
            // then apply the scaled slider translations.
            
            // To properly map, think of it as scaling the *entire coordinate system* from 600x600 to 1920x1920.
            // The preview's (0,0) becomes (0,0) in high-res.
            // The preview's `left` and `top` properties (relative to parent) are scaled up.
            // The `translate` values from sliders are also scaled up.

            // The 'user-image' CSS has `left: 0; top: 0;` and `transform-origin: center;`
            // and then `transform: translate(${xPos}px, ${yPos}px) scale(${scale})`
            // Let's replicate this behavior in the high-res context.

            // Calculate the full rendered width/height of the user image considering original aspect ratio and slider scale
            let finalRenderWidth, finalRenderHeight;
            if (naturalWidth && naturalHeight) {
                const effectivePreviewWidth = previewContainer.offsetWidth; // This is 600px or less on smaller screens
                const effectivePreviewHeight = previewContainer.offsetHeight;

                const baseImageRatio = naturalWidth / naturalHeight;

                // Determine base dimensions for `object-fit: contain` within 600x600 before scaling
                let previewBaseWidth, previewBaseHeight;
                if (baseImageRatio > 1) { // Landscape
                    previewBaseWidth = effectivePreviewWidth;
                    previewBaseHeight = effectivePreviewWidth / baseImageRatio;
                } else { // Portrait or Square
                    previewBaseHeight = effectivePreviewHeight;
                    previewBaseWidth = effectivePreviewHeight * baseImageRatio;
                }
                
                // Apply the user's scale
                finalRenderWidth = previewBaseWidth * currentScale * renderScaleFactor;
                finalRenderHeight = previewBaseHeight * currentScale * renderScaleFactor;

            } else {
                // Fallback if natural dimensions not available, assume it fills the preview container
                finalRenderWidth = previewContainerSize * currentScale * renderScaleFactor;
                finalRenderHeight = previewContainerSize * currentScale * renderScaleFactor;
            }

            hiResUserImage.style.cssText = `
                position: absolute;
                width: ${finalRenderWidth}px;
                height: ${finalRenderHeight}px;
                /* No object-fit: contain here, as we are setting explicit width/height */
                transform-origin: center; /* Important: match preview's transform-origin */
                left: 50%;
                top: 50%;
                transform: translate(
                    calc(-50% + ${scaledXTranslation}px),
                    calc(-50% + ${scaledYTranslation}px)
                ) scale(1); /* Scale is already baked into width/height, set to 1 here */
                display: block;
                z-index: 5;
            `;

            hiResFrameImage.style.cssText = `
                position: absolute;
                width: 100%;
                height: 100%;
                object-fit: contain;
                pointer-events: none;
                z-index: 10;
                top: 0;
                left: 0;
                display: block;
            `;

            tempRenderDiv.appendChild(hiResUserImage);
            tempRenderDiv.appendChild(hiResFrameImage);

            html2canvas(tempRenderDiv, {
                width: tempDivSize,
                height: tempDivSize,
                scale: 1, // Already rendering at target size
                backgroundColor: null,
                useCORS: false,
                allowTaint: false,
                logging: true,
                imageTimeout: 15000
            }).then(canvas => {
                document.body.removeChild(tempRenderDiv);
                
                const imageDataURL = canvas.toDataURL('image/png');

                if (isMobileDevice()) {
                  // For mobile/tablet, show in modal
                  modalImage.src = imageDataURL;
                  downloadModalBtn.classList.add('hidden'); // Hide desktop download button in modal for mobile
                  imageModal.classList.remove('hidden');
                } else {
                  // For desktop, directly download
                  try {
                      const link = document.createElement('a');
                      link.download = `profile-${selectedFrame}-gama-awards.png`;
                      link.href = imageDataURL; 
                      link.click();
                  } catch (e) {
                      console.error('Error creating data URL or download link:', e);
                      alert('ไม่สามารถดาวน์โหลดรูปภาพได้ (อาจเกิดจากปัญหาภายในหรือรูปภาพต้นฉบับเสียหาย)');
                  }
                }
                
                loadingOverlay.classList.add('hidden');
            }).catch(err => {
                console.error('Error generating image with html2canvas:', err);
                alert('เกิดข้อผิดพลาดในการสร้างรูปภาพ กรุณาลองใหม่อีกครั้ง');
                document.body.removeChild(tempRenderDiv); 
                loadingOverlay.classList.add('hidden');
            });
        }).catch(err => {
            console.error('Error waiting for high-res images to load:', err);
            alert('เกิดข้อผิดพลาดในการเตรียมรูปภาพเพื่อดาวน์โหลด กรุณาลองใหม่อีกครั้ง');
            document.body.removeChild(tempRenderDiv);
            loadingOverlay.classList.add('hidden');
        });
      });

      // Close modal button listener
      closeModalBtn.addEventListener('click', function() {
        imageModal.classList.add('hidden');
      });

      // Desktop download button inside modal (only visible on desktop)
      downloadModalBtn.addEventListener('click', function() {
        const link = document.createElement('a');
        link.download = `profile-${selectedFrame}-gama-awards.png`;
        link.href = modalImage.src; 
        link.click();
        imageModal.classList.add('hidden');
      });

      // Show/hide downloadModalBtn based on device type when modal is opened (or page load)
      if (isMobileDevice()) {
        downloadModalBtn.classList.add('hidden');
      } else {
        downloadModalBtn.classList.remove('hidden');
      }
    });
  </script>
</body>
</html>
