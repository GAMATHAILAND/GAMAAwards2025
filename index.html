<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GAMA Awards Frame Creator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Prompt', sans-serif;
            background-color: white;
            min-height: 100vh;
            color: #333;
        }

        .frame-option {
            transition: all 0.3s ease;
            cursor: pointer;
            background-color: white;
            border: 1px solid #e5e7eb;
        }

        .frame-option:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        .frame-option.selected {
            border: 3px solid #4500b2;
            transform: translateY(-5px);
        }

        /* Canvas container for preview */
        .canvas-container {
            position: relative;
            width: 600px; /* Base size for preview */
            height: 600px;
            overflow: hidden;
            margin: 0 auto;
            background-color: #f9fafb;
            border: 2px dashed #d1d5db;
            border-radius: 8px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        @media (max-width: 640px) {
            .canvas-container {
                width: 100%;
                height: 300px;
            }
        }

        /* Styles for the preview canvas */
        #previewCanvas {
            display: block;
            max-width: 100%;
            max-height: 100%;
        }

        .slider {
            -webkit-appearance: none;
            height: 8px;
            border-radius: 4px;
            background: #e5e7eb;
            outline: none;
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #4500b2;
            cursor: pointer;
        }

        .slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #4500b2;
            cursor: pointer;
        }

        .btn {
            transition: all 0.3s ease;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            color: white;
            font-size: 24px;
        }

        .spinner {
            border: 5px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 5px solid white;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }

        .card {
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        .file-upload {
            position: relative;
            overflow: hidden;
            display: inline-block;
            width: 100%;
        }

        .file-upload input[type=file] {
            position: absolute;
            top: 0;
            right: 0;
            min-width: 100%;
            min-height: 100%;
            font-size: 100px;
            text-align: right;
            filter: alpha(opacity=0);
            opacity: 0;
            outline: none;
            cursor: pointer;
            display: block;
        }

        .header-gradient {
            background: linear-gradient(to right, #4500b2, #d83361);
            height: 8px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Placeholder text inside canvas container */
        #placeholderText {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1; /* Ensure it's behind the canvas if canvas is present */
        }
        #placeholderText.hidden {
            display: none;
        }
        
        /* Hidden Canvas for Download */
        #hiddenCanvas {
            display: none; /* Keep this hidden */
        }
    </style>
</head>
<body class="min-h-screen">
    <div class="header-gradient"></div>
    <div class="container mx-auto px-4 py-8">
        <div class="flex justify-center mb-6">
            <img src="https://hugmediacreation.com/wp-content/uploads/2025/06/logo-gama-awards.png" alt="GAMA Awards Logo" class="h-[97.5px]"> 
        </div>
        <h1 class="text-3xl font-bold text-center text-gray-800 mb-4">GAMA Awards Frame</h1>
        <p class="text-center text-gray-600 mb-8 max-w-2xl mx-auto">เปลี่ยนรูปโปรไฟล์ของคุณให้โดดเด่นด้วยกรอบรูปภาพพิเศษจาก GAMA Awards อัพโหลดรูปภาพของคุณ เลือกกรอบที่ชอบ และดาวน์โหลดเพื่อใช้เป็นรูปโปรไฟล์ใหม่ของคุณ</p>
        
        <div class="mb-8 max-w-xl mx-auto">
            <div class="card p-6">
                <label class="block text-lg font-medium mb-3 text-gray-700">อัพโหลดรูปโปรไฟล์ของคุณ:</label>
                <div class="file-upload">
                    <button id="uploadBtn" class="w-full bg-gradient-to-r from-purple-800 to-pink-600 hover:from-purple-700 hover:to-pink-500 text-white py-3 px-6 rounded-lg font-medium flex items-center justify-center btn">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 0 003 3h10a3 0 003-3v-1m-4-8l-4-4m0 0l-4 4m4-4v12" />
                        </svg>
                        เลือกรูปภาพจากเครื่อง
                    </button>
                    <input type="file" id="imageUpload" accept="image/*">
                </div>
                <p id="selectedFileName" class="mt-2 text-center text-sm text-gray-500"></p>
            </div>
        </div>
        
        <div class="mb-8">
            <h2 class="text-xl font-medium mb-4 text-center text-gray-700">เลือกกรอบรูปภาพ</h2>
            <div id="frameOptionsContainer" class="flex flex-wrap justify-center gap-3">
                </div>
        </div>
        
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
            <div class="lg:col-span-2">
                <div class="card p-4">
                    <div class="canvas-container" id="previewContainer">
                        <div id="placeholderText" class="text-center p-4">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mx-auto mb-2 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 0 00-2-2H6a2 0 00-2 2v12a2 0 002 2z" />
                            </svg>
                            <p class="text-gray-500">โปรดอัพโหลดรูปภาพและเลือกกรอบ</p>
                        </div>
                        <canvas id="previewCanvas"></canvas>
                    </div>
                </div>
            </div>
            
            <div class="card p-6">
                <h3 class="text-lg font-medium mb-4 text-gray-700">ปรับแต่งรูปภาพ</h3>
                
                <div class="mb-4">
                    <label for="sizeSlider" class="block text-sm font-medium mb-1 text-gray-600">ขนาด:</label>
                    <input type="range" id="sizeSlider" class="slider w-full" min="0.1" max="2.0" step="0.01" value="1.0">
                    <div class="flex justify-between text-xs text-gray-500">
                        <span>เล็ก</span>
                        <span>ใหญ่</span>
                    </div>
                </div>
                
                <div class="mb-4">
                    <label for="horizontalSlider" class="block text-sm font-medium mb-1 text-gray-600">ตำแหน่งแนวนอน:</label>
                    <input type="range" id="horizontalSlider" class="slider w-full" min="-0.5" max="0.5" step="0.01" value="0">
                    <div class="flex justify-between text-xs text-gray-500">
                        <span>ซ้าย</span>
                        <span>ขวา</span>
                    </div>
                </div>
                
                <div class="mb-6">
                    <label for="verticalSlider" class="block text-sm font-medium mb-1 text-gray-600">ตำแหน่งแนวตั้ง:</label>
                    <input type="range" id="verticalSlider" class="slider w-full" min="-0.5" max="0.5" step="0.01" value="0">
                    <div class="flex justify-between text-xs text-gray-500">
                        <span>บน</span>
                        <span>ล่าง</span>
                    </div>
                </div>
                
                <button id="downloadBtn" class="w-full bg-gradient-to-r from-purple-800 to-pink-600 hover:from-purple-700 hover:to-pink-500 text-white py-3 px-6 rounded-lg font-medium flex items-center justify-center btn disabled:opacity-50 disabled:cursor-not-allowed mb-3" disabled>
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 0 003 3h10a3 0 003-3v-1m-4-8l-4-4m0 0l-4 4m4-4v12" />
                    </svg>
                    ดาวน์โหลดรูปโปรไฟล์
                </button>
                
                <p class="mt-4 text-sm text-gray-500 text-center">ดาวน์โหลดและใช้เป็นรูปโปรไฟล์ของคุณบนโซเชียลมีเดีย</p>
            </div>
        </div>
        
        <div class="text-center text-sm text-gray-500 mb-8">
            © GAMA Awards 2025 - ระบบใส่กรอบรูปภาพ
        </div>
    </div>
    
    <div id="loadingOverlay" class="loading hidden">
        <div class="spinner"></div>
        <span>กำลังประมวลผล...</span>
    </div>

    <canvas id="hiddenCanvas"></canvas>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Elements
            const imageUpload = document.getElementById('imageUpload');
            const uploadBtn = document.getElementById('uploadBtn');
            const selectedFileName = document.getElementById('selectedFileName');
            const frameOptionsContainer = document.getElementById('frameOptionsContainer'); 
            const placeholderText = document.getElementById('placeholderText');
            
            const sizeSlider = document.getElementById('sizeSlider');
            const horizontalSlider = document.getElementById('horizontalSlider');
            const verticalSlider = document.getElementById('verticalSlider');
            
            const previewCanvas = document.getElementById('previewCanvas');
            const hiddenCanvas = document.getElementById('hiddenCanvas');
            const downloadBtn = document.getElementById('downloadBtn');
            const loadingOverlay = document.getElementById('loadingOverlay');

            const ctxPreview = previewCanvas.getContext('2d');
            const ctxHidden = hiddenCanvas.getContext('2d');

            // State variables
            let userImage = null;
            let selectedFrameId = null;
            let frameImages = {}; // Stores actual Image objects of frames

            // Frame URLs (UPDATED TO EXTERNAL URLs)
            const frames = [
                { id: 'MAA', name: 'Master Multiline Award', url: 'https://hugmediacreation.com/photo/MASTER%20MULTILINE%20Award.png' },
                { id: 'MFA', name: 'Master Firm Award', url: 'https://hugmediacreation.com/photo/MASTER%20FIRM%20Award.png' },
                { id: 'MMA', name: 'Master Agency Award', url: 'https://hugmediacreation.com/photo/MASTER%20AGENCY%20Award.png' },
                { id: 'IMA', name: 'International Management Award', url: 'https://hugmediacreation.com/photo/International%20Management%20Award.png' },
                { id: 'FLA', name: 'Frontline Leader Award', url: 'https://hugmediacreation.com/photo/Frontline%20Leader%20Awards.png' },
                { id: 'ERA', name: 'Excellence Recruitment Awards', url: 'https://hugmediacreation.com/photo/Excellence%20Recruitment%20Award.png' }, 
                { id: 'COE', name: 'Circle of Excellence Award', url: 'https://hugmediacreation.com/photo/Circle%20of%20Excellence%20Award.png' }
            ];

            // Canvas sizes
            const previewCanvasSize = 600; // Match .canvas-container width/height
            previewCanvas.width = previewCanvasSize;
            previewCanvas.height = previewCanvasSize;

            const downloadCanvasSize = 1920; // Required download size
            hiddenCanvas.width = downloadCanvasSize;
            hiddenCanvas.height = downloadCanvasSize;

            // --- Core Logic Functions ---

            // Function to load all frame images into memory
            async function loadFrameImages() {
                for (const frame of frames) {
                    const img = new Image();
                    img.src = frame.url;
                    img.crossOrigin = "anonymous"; // IMPORTANT for CORS when drawing to canvas from external URLs
                    await new Promise(resolve => {
                        img.onload = () => {
                            frameImages[frame.id] = img;
                            resolve();
                        };
                        img.onerror = () => {
                            console.error(`Failed to load frame image: ${frame.url}. Ensure the URL is correct and the server supports CORS.`);
                            alert(`ไม่สามารถโหลดกรอบรูป ${frame.id} ได้! โปรดตรวจสอบว่า URL ถูกต้อง หรืออาจเกิดจากปัญหา CORS บนเซิร์ฟเวอร์.`);
                            resolve(); // Resolve anyway to not block other images
                        };
                    });
                }
                renderFrameThumbnails(); // Render thumbnails after all images are attempted to load
            }

            // Function to render frame thumbnails dynamically
            function renderFrameThumbnails() {
                frameOptionsContainer.innerHTML = ''; // Clear existing thumbnails
                frames.forEach(frame => {
                    const optionDiv = document.createElement('div');
                    optionDiv.classList.add('frame-option', 'rounded-lg', 'p-2', 'text-center');
                    optionDiv.dataset.frame = frame.id;

                    const img = document.createElement('img');
                    img.src = frame.url;
                    img.alt = frame.name;
                    img.crossOrigin = "anonymous"; // Also set for thumbnails
                    img.classList.add('w-20', 'h-20', 'object-contain', 'mx-auto');

                    const p = document.createElement('p');
                    p.classList.add('text-sm', 'font-medium', 'mt-1', 'text-gray-800');
                    p.textContent = frame.id;

                    optionDiv.appendChild(img);
                    optionDiv.appendChild(p);

                    optionDiv.addEventListener('click', function() {
                        // Remove 'selected' class from all other options
                        document.querySelectorAll('.frame-option').forEach(opt => opt.classList.remove('selected'));
                        this.classList.add('selected'); // Add 'selected' to clicked one

                        selectedFrameId = frame.id; // Set the selected frame ID
                        drawCanvasPreview(); // Redraw preview
                    });
                    frameOptionsContainer.appendChild(optionDiv);
                });
            }

            // Function to draw image and frame on a given canvas context
            function drawImageAndFrame(ctx, canvasSize) {
                ctx.clearRect(0, 0, canvasSize, canvasSize); // Clear canvas

                // Draw user image if available
                if (userImage) {
                    const imgWidth = userImage.width;
                    const imgHeight = userImage.height;

                    // Sliders values: scale 0.1-2.0, pos -0.5 to 0.5 (relative to canvas center)
                    const scale = parseFloat(sizeSlider.value);
                    const horizontalShiftRatio = parseFloat(horizontalSlider.value); // -0.5 to 0.5
                    const verticalShiftRatio = parseFloat(verticalSlider.value); // -0.5 to 0.5

                    // Calculate effective source dimensions and position for "cover" effect
                    let sx, sy, sWidth, sHeight; // Source rectangle
                    let dx, dy, dWidth, dHeight; // Destination rectangle on canvas

                    const imgAspectRatio = imgWidth / imgHeight;
                    const canvasAspectRatio = canvasSize / canvasSize; // Always 1 for square

                    // Determine what part of the source image to use (sWidth, sHeight)
                    if (imgAspectRatio > canvasAspectRatio) {
                        // Image is wider, scale height to match canvas height, crop width
                        sHeight = imgHeight;
                        sWidth = imgHeight * canvasAspectRatio;
                    } else {
                        // Image is taller, scale width to match canvas width, crop height
                        sWidth = imgWidth;
                        sHeight = imgWidth / canvasAspectRatio;
                    }

                    // Apply zoom (scale) to source dimensions
                    sWidth /= scale;
                    sHeight /= scale;

                    // Calculate source X and Y to center the scaled portion
                    sx = (imgWidth - sWidth) / 2;
                    sy = (imgHeight - sHeight) / 2;

                    // Apply horizontal and vertical shifts relative to canvas size
                    dx = horizontalShiftRatio * canvasSize;
                    dy = verticalShiftRatio * canvasSize;

                    // Set destination dimensions to cover the canvas
                    dWidth = canvasSize;
                    dHeight = canvasSize;

                    // Draw the user image onto the canvas
                    ctx.drawImage(userImage, sx, sy, sWidth, sHeight, dx, dy, dWidth, dHeight);
                }

                // Draw selected frame on top
                if (selectedFrameId && frameImages[selectedFrameId]) {
                    ctx.drawImage(frameImages[selectedFrameId], 0, 0, canvasSize, canvasSize);
                }
            }

            // Function to draw on the preview canvas and manage button state
            function drawCanvasPreview() {
                // If no user image or no frame selected, display placeholder
                if (!userImage || !selectedFrameId) {
                    placeholderText.classList.remove('hidden');
                    downloadBtn.disabled = true;
                    ctxPreview.clearRect(0, 0, previewCanvasSize, previewCanvasSize); // Clear canvas
                } else {
                    placeholderText.classList.add('hidden');
                    drawImageAndFrame(ctxPreview, previewCanvasSize); // Draw on preview canvas
                    downloadBtn.disabled = false; // Enable download button
                }
            }

            // --- Event Listeners ---

            // Trigger file input when the upload button is clicked
            uploadBtn.addEventListener('click', function() {
                imageUpload.click();
            });

            // Handle file upload
            imageUpload.addEventListener('change', function() {
                if (this.files && this.files[0]) {
                    const file = this.files[0];
                    selectedFileName.textContent = file.name;
                    
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const img = new Image();
                        img.onload = () => {
                            userImage = img;
                            // Reset sliders to default when a new image is loaded
                            sizeSlider.value = 1.0;
                            horizontalSlider.value = 0;
                            verticalSlider.value = 0;
                            drawCanvasPreview(); // Redraw preview with new image
                        };
                        img.onerror = () => {
                            alert('เกิดข้อผิดพลาดในการโหลดรูปภาพของคุณ กรุณาลองใหม่');
                            userImage = null; // Reset user image state
                            selectedFileName.textContent = '';
                            drawCanvasPreview(); // Redraw preview to show placeholder
                        };
                        img.src = e.target.result;
                    };
                    reader.readAsDataURL(file);
                } else {
                    selectedFileName.textContent = '';
                    userImage = null; // Reset user image state
                    drawCanvasPreview(); // Redraw preview to show placeholder
                }
            });
            
            // Event listeners for sliders (trigger redraw on preview)
            sizeSlider.addEventListener('input', drawCanvasPreview);
            horizontalSlider.addEventListener('input', drawCanvasPreview);
            verticalSlider.addEventListener('input', drawCanvasPreview);

            // Download functionality
            downloadBtn.addEventListener('click', function() {
                if (!userImage || !selectedFrameId) {
                    alert('โปรดอัปโหลดรูปภาพและเลือกกรอบก่อนดาวน์โหลด');
                    return;
                }

                loadingOverlay.classList.remove('hidden'); // Show loading spinner

                // Draw the final high-resolution image onto the hidden canvas
                drawImageAndFrame(ctxHidden, downloadCanvasSize);

                try {
                    const link = document.createElement('a');
                    link.download = `profile-${selectedFrameId}-gama-awards.png`;
                    link.href = hiddenCanvas.toDataURL('image/png'); // Get data URL from hidden canvas
                    
                    // Programmatically click the link for download
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);

                    alert('รูปภาพถูกเตรียมสำหรับการดาวน์โหลดแล้ว! โปรดแตะปุ่ม "บันทึกรูปภาพ" หรือ "ดาวน์โหลด" ในหน้าจอถัดไปเพื่อบันทึกลงเครื่องของคุณ');
                } catch (e) {
                    console.error('Error generating image or download link:', e);
                    alert('ไม่สามารถดาวน์โหลดรูปภาพได้ (อาจเกิดจากปัญหา CORS หรือรูปภาพต้นฉบับเสียหาย)');
                } finally {
                    loadingOverlay.classList.add('hidden'); // Hide loading spinner
                }
            });

            // Initialize: Load frame images and render thumbnails
            loadFrameImages();
        });
    </script>
</body>
</html>
